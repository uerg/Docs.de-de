---
uid: mvc/overview/security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages
title: XSRF/CSRF-Schutz in ASP.NET MVC und Webseiten | Microsoft-Dokumentation
author: Rick-Anderson
description: Websiteübergreifende anforderungsfälschung (auch bekannt als XSRF oder CSRF) ist ein Angriff gegen Web gehostete Anwendungen, die durch eine schädliche Website die Interakti beeinflussen können...
ms.author: riande
ms.date: 03/14/2013
ms.assetid: aadc5fa4-8215-4fc7-afd5-bcd2ef879728
msc.legacyurl: /mvc/overview/security/xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages
msc.type: authoredcontent
ms.openlocfilehash: cd1b8de51c180471ab273c4541959368ffbd48a3
ms.sourcegitcommit: 45ac74e400f9f2b7dbded66297730f6f14a4eb25
ms.translationtype: MT
ms.contentlocale: de-DE
ms.lasthandoff: 08/16/2018
ms.locfileid: "41829517"
---
<a name="xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages"></a><span data-ttu-id="3c089-103">XSRF/CSRF-Schutz in ASP.NET MVC und Webseiten</span><span class="sxs-lookup"><span data-stu-id="3c089-103">XSRF/CSRF Prevention in ASP.NET MVC and Web Pages</span></span>
====================
<span data-ttu-id="3c089-104">durch [Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="3c089-104">by [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="3c089-105">Cross-Site-Anforderung, dass anforderungsfälschung (auch bekannt als XSRF oder CSRF) einen Angriff auf das Web gehostete Anwendungen wird durch eine schädliche Website die Interaktion zwischen einem Clientbrowser und einer Website, die von diesem Browser als vertrauenswürdig eingestuft beeinflussen können.</span><span class="sxs-lookup"><span data-stu-id="3c089-105">Cross-site request forgery (also known as XSRF or CSRF) is an attack against web-hosted applications whereby a malicious web site can influence the interaction between a client browser and a web site trusted by that browser.</span></span> <span data-ttu-id="3c089-106">Diese Angriffe sind möglich, da Webbrowser Authentifizierungstoken automatisch mit jeder Anforderung an eine Website gesendet werden.</span><span class="sxs-lookup"><span data-stu-id="3c089-106">These attacks are made possible because web browsers will send authentication tokens automatically with every request to a web site.</span></span> <span data-ttu-id="3c089-107">Das kanonische Beispiel ist ein Authentifizierungscookie, z. B. ASP. NET Forms-Authentifizierungsticket.</span><span class="sxs-lookup"><span data-stu-id="3c089-107">The canonical example is an authentication cookie, such as ASP.NET's Forms Authentication ticket.</span></span> <span data-ttu-id="3c089-108">Allerdings können Websites, die einen persistenten Authentifizierungsmechanismus (z. B. Windows-Authentifizierung, Basic, usw.) verwenden diese Angriffe verwendet werden.</span><span class="sxs-lookup"><span data-stu-id="3c089-108">However, web sites which use any persistent authentication mechanism (such as Windows Authentication, Basic, and so forth) can be targeted by these attacks.</span></span>
> 
> <span data-ttu-id="3c089-109">Ein XSRF-Angriff unterscheidet sich von einem Phishing-Angriff.</span><span class="sxs-lookup"><span data-stu-id="3c089-109">An XSRF attack is distinct from a phishing attack.</span></span> <span data-ttu-id="3c089-110">Phishing-Angriffe erfordern Beihilfe des Opfers.</span><span class="sxs-lookup"><span data-stu-id="3c089-110">Phishing attacks require interaction from the victim.</span></span> <span data-ttu-id="3c089-111">Bei einem Phishing-Angriff der entsprechenden Website eine schädliche Website imitiert und das Opfer wird dazu verleitet vertraulichen Informationen an den Angreifer.</span><span class="sxs-lookup"><span data-stu-id="3c089-111">In a phishing attack, a malicious web site will mimic the target web site, and the victim is fooled into providing sensitive information to the attacker.</span></span> <span data-ttu-id="3c089-112">Bei einem XSRF-Angriff besteht häufig keine Interaktion des Opfers erforderlich.</span><span class="sxs-lookup"><span data-stu-id="3c089-112">In an XSRF attack, there is often no interaction necessary from the victim.</span></span> <span data-ttu-id="3c089-113">Stattdessen der Angreifer im Browser automatisch alle relevanten Cookies an die Ziel-Website senden setzt voraus, dass.</span><span class="sxs-lookup"><span data-stu-id="3c089-113">Rather, the attacker is relying on the browser automatically sending all relevant cookies to the destination web site.</span></span>
> 
> <span data-ttu-id="3c089-114">Weitere Informationen finden Sie unter den [Open Web Application Security Project](https://www.owasp.org/index.php/Main_Page)(OWASP) [XSRF](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)).</span><span class="sxs-lookup"><span data-stu-id="3c089-114">For more information, see the [Open Web Application Security Project](https://www.owasp.org/index.php/Main_Page)(OWASP) [XSRF](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)).</span></span>


## <a name="anatomy-of-an-attack"></a><span data-ttu-id="3c089-115">Anatomie eines Angriffs</span><span class="sxs-lookup"><span data-stu-id="3c089-115">Anatomy of an attack</span></span>

<span data-ttu-id="3c089-116">Um ein XSRF-Angriff zu durchlaufen, sollten Sie in ein Benutzer, der einige Transaktionen Onlinebanking ausführen möchte.</span><span class="sxs-lookup"><span data-stu-id="3c089-116">To walk through an XSRF attack, consider a user who wants to perform some online banking transactions.</span></span> <span data-ttu-id="3c089-117">Dieser Benutzer besucht zuerst WoodgroveBank.com und Protokolle, an diesem, die Punkt der Antwortheader ihr Authentifizierungscookie enthält:</span><span class="sxs-lookup"><span data-stu-id="3c089-117">This user first visits WoodgroveBank.com and logs in, at which point the response header will contain her authentication cookie:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample1.cmd)]

<span data-ttu-id="3c089-118">Da das Authentifizierungscookie ein Sitzungscookie ist, wird er automatisch vom Browser zurückgesetzt, wenn der Browserprozess beendet wird.</span><span class="sxs-lookup"><span data-stu-id="3c089-118">Because the authentication cookie is a session cookie, it will be automatically cleared by the browser when the browser process exits.</span></span> <span data-ttu-id="3c089-119">Allerdings wird der Browser bis zu diesem Zeitpunkt automatisch das Cookie mit jeder Anforderung an WoodgroveBank.com enthalten.</span><span class="sxs-lookup"><span data-stu-id="3c089-119">However, until that time, the browser will automatically include the cookie with each request to WoodgroveBank.com.</span></span> <span data-ttu-id="3c089-120">Der Benutzer möchte nun $1000 an ein anderes Konto übertragen wird, so dass er ein Formular auf die Banking-Site füllt, und der Browser diese Anforderung an dem Server sendet:</span><span class="sxs-lookup"><span data-stu-id="3c089-120">The user now wants to transfer $1000 to another account, so she fills out a form on the banking site, and the browser makes this request to the server:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample2.cmd)]

<span data-ttu-id="3c089-121">Da dieser Vorgang einen Nebeneffekt hat (es wird eine finanzielle Transaktion initiiert), hat die Banking-Site möchten erfordert einen HTTP-POST, um diesen Vorgang zu initiieren.</span><span class="sxs-lookup"><span data-stu-id="3c089-121">Because this operation has a side effect (it initiates a monetary transaction), the banking site has chosen to require an HTTP POST in order to initiate this operation.</span></span> <span data-ttu-id="3c089-122">Der Server liest das Authentifizierungstoken aus der Anforderung, sucht der Kontonummer des aktuellen Benutzers, stellt sicher, dass ausreichende Geldmittel vorhanden sein, und klicken Sie dann die Transaktion in das Zielkonto initiiert.</span><span class="sxs-lookup"><span data-stu-id="3c089-122">The server reads the authentication token from the request, looks up the current user's account number, verifies that sufficient funds exist, and then initiates the transaction into the destination account.</span></span>

<span data-ttu-id="3c089-123">Ihrer Onlinebanking abgeschlossen haben, der Benutzer navigiert, Weg von der Banking-Site und wechselt zu anderen Speicherorten im Web.</span><span class="sxs-lookup"><span data-stu-id="3c089-123">Her online banking complete, the user navigates away from the banking site and visits other locations on the web.</span></span> <span data-ttu-id="3c089-124">Eine dieser Websites – "Fabrikam.com" – enthält das folgende Markup auf einer Seite eingebettet in ein &lt;Iframe&gt;:</span><span class="sxs-lookup"><span data-stu-id="3c089-124">One of those sites – fabrikam.com – includes the following markup on a page embedded within an &lt;iframe&gt;:</span></span>

[!code-html[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample3.html)]

<span data-ttu-id="3c089-125">Welche führt dazu, dass den Browser für diese Anforderung:</span><span class="sxs-lookup"><span data-stu-id="3c089-125">Which then causes the browser to make this request:</span></span>

[!code-console[Main](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/samples/sample4.cmd)]

<span data-ttu-id="3c089-126">Der Angreifer missbraucht die Tatsache, dass der Benutzer möglicherweise weiterhin ein gültiges Authentifizierungstoken für die Ziel-Website, und sie ein kleines Snippet von Javascript verwendet ist, auf den Browser dazu bringt, stellen eine HTTP-POST automatisch an den Zielstandort.</span><span class="sxs-lookup"><span data-stu-id="3c089-126">The attacker is exploiting the fact that the user might still have a valid authentication token for the target web site, and she is using a small snippet of Javascript to cause the browser to make an HTTP POST to the target site automatically.</span></span> <span data-ttu-id="3c089-127">Wenn das Authentifizierungstoken noch gültig ist, initiiert die Banking-Site eine Übertragung von 250 USD in das Konto des Angreifers auszuwählen.</span><span class="sxs-lookup"><span data-stu-id="3c089-127">If the authentication token is still valid, the banking site will initiate a transfer of $250 into the account of the attacker's choosing.</span></span>

### <a name="ineffective-mitigations"></a><span data-ttu-id="3c089-128">Damit Sie nicht versehentlich entschärfungen</span><span class="sxs-lookup"><span data-stu-id="3c089-128">Ineffective mitigations</span></span>

<span data-ttu-id="3c089-129">Es ist interessant, dass in diesem Szenario die Tatsache, dass WoodgroveBank.com über SSL zugegriffen wurde, und es ein Cookie nur SSL-Authentifizierung musste nicht ausreichend, um den Angriff abzuwehren war.</span><span class="sxs-lookup"><span data-stu-id="3c089-129">It is interesting to note that in the above scenario, the fact that WoodgroveBank.com was being accessed via SSL and had an SSL-only authentication cookie was insufficient to thwart the attack.</span></span> <span data-ttu-id="3c089-130">Der Angreifer kann an die [URI-Schema](http://en.wikipedia.org/wiki/URI_scheme) (Https) in ihrem &lt;Formular&gt; Element, und der Browser weiterhin nicht abgelaufene Cookies an den Zielstandort senden, solange diese Cookies mit dem URI konsistent sind Schema, der das gewünschte Ziel.</span><span class="sxs-lookup"><span data-stu-id="3c089-130">The attacker is able to specify the [URI scheme](http://en.wikipedia.org/wiki/URI_scheme) (https) in her &lt;form&gt; element, and the browser will continue to send unexpired cookies to the target site as long as those cookies are consistent with the URI scheme of the intended target.</span></span>

<span data-ttu-id="3c089-131">Man könnte argumentieren, dass der Benutzer nicht besuchen Sie einfach sollte nicht vertrauenswürdige Sites, als der Zugriff auf nur vertrauenswürdige Sites können online sicher bleiben.</span><span class="sxs-lookup"><span data-stu-id="3c089-131">One could argue that the user should simply not visit untrusted sites, as visiting only trusted sites is helps to remain safe online.</span></span> <span data-ttu-id="3c089-132">Es gibt einige Weg, dies allerdings leider diese Empfehlung ist nicht immer praktikabel.</span><span class="sxs-lookup"><span data-stu-id="3c089-132">There is some truth to this, but unfortunately this advice is not always practical.</span></span> <span data-ttu-id="3c089-133">Vielleicht vertraut"der Benutzer" die Website regionalnachrichten ConsolidatedMessenger.</span><span class="sxs-lookup"><span data-stu-id="3c089-133">Perhaps the user "trusts" the local news site ConsolidatedMessenger.</span></span> <span data-ttu-id="3c089-134">ConsolidatedMessenger.com und wechselt zu finden, die stattdessen Website, aber dieser Standort verfügt über einer XSS-Schwachstelle Dadurch kann einen Angreifer, gleichen den Codeausschnitt einzufügen, die auf "Fabrikam.com" ausgeführt wurde.</span><span class="sxs-lookup"><span data-stu-id="3c089-134">ConsolidatedMessenger.com and goes to visit that site instead, but that site has an XSS vulnerability which allows an attacker to inject the same snippet of code that was running on fabrikam.com.</span></span>

<span data-ttu-id="3c089-135">Sie können sicherstellen, dass eingehende Anforderungen eine [referenzheader](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) verweisen auf Ihre Domäne.</span><span class="sxs-lookup"><span data-stu-id="3c089-135">You can verify that incoming requests have a [Referer header](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) referencing your domain.</span></span> <span data-ttu-id="3c089-136">Dies beendet die Anforderungen, die von einer Drittanbieter-Domäne unwissentlich übermittelt.</span><span class="sxs-lookup"><span data-stu-id="3c089-136">This will stop requests unwittingly submitted from a third-party domain.</span></span> <span data-ttu-id="3c089-137">Allerdings einige Leute Deaktivieren des Browsers Referer-Header aus Datenschutzgründen und Angreifer können manchmal diesen Header vortäuschen, wenn das Opfer bestimmte unsichere-Software installiert ist.</span><span class="sxs-lookup"><span data-stu-id="3c089-137">However, some people disable their browser's Referer header for privacy reasons, and attackers can sometimes spoof that header if the victim has certain insecure software installed.</span></span> <span data-ttu-id="3c089-138">Überprüfen der [referenzheader](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) einen sichereren Ansatz zum Schutz vor XSRF-Angriffen wird nicht berücksichtigt.</span><span class="sxs-lookup"><span data-stu-id="3c089-138">Verifying the [Referer header](http://www.w3.org/Protocols/HTTP/HTRQ_Headers.html#z14) is not considered a secure approach to preventing XSRF attacks.</span></span>

## <a name="web-stack-runtime-xsrf-mitigations"></a><span data-ttu-id="3c089-139">Web Stack Runtime XSRF-entschärfungen</span><span class="sxs-lookup"><span data-stu-id="3c089-139">Web Stack Runtime XSRF mitigations</span></span>

<span data-ttu-id="3c089-140">Der ASP.NET Web Stack Common Language Runtime verwendet eine Variante der [für die domänensynchronisierung tokenmuster](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern) zur Verteidigung gegen XSRF-Angriffe.</span><span class="sxs-lookup"><span data-stu-id="3c089-140">The ASP.NET Web Stack Runtime uses a variant of the [synchronizer token pattern](https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)_Prevention_Cheat_Sheet#General_Recommendation:_Synchronizer_Token_Pattern) to defend against XSRF attacks.</span></span> <span data-ttu-id="3c089-141">Die allgemeine Form des Tokens für die domänensynchronisierung-Musters ist, dass zwei Anti-XSRF-Token mit jeder HTTP-POST (zusätzlich zu dem Authentifizierungstoken) an den Server übermittelt werden: eine als ein Cookie, und der andere wird als ein Formularwert-Token.</span><span class="sxs-lookup"><span data-stu-id="3c089-141">The general form of the synchronizer token pattern is that two anti-XSRF tokens are submitted to the server with each HTTP POST (In addition to the authentication token): one token as a cookie, and the other as a form value.</span></span> <span data-ttu-id="3c089-142">Die Tokenwerte generiert, die von der ASP.NET-Laufzeit sind nicht deterministisch oder von einem Angreifer vorhersagbar.</span><span class="sxs-lookup"><span data-stu-id="3c089-142">The token values generated by the ASP.NET runtime are not deterministic or predictable by an attacker.</span></span> <span data-ttu-id="3c089-143">Wenn die Token gesendet werden, lässt der Server die Anforderung fortgesetzt werden, nur dann, wenn beide Token ein Vergleich bestehen.</span><span class="sxs-lookup"><span data-stu-id="3c089-143">When the tokens are submitted, the server will allow the request to proceed only if both tokens pass a comparison check.</span></span>

<span data-ttu-id="3c089-144">Die Anforderung XSRF-Überprüfung *Sitzungstoken* wird als ein HTTP-Cookie gespeichert und enthält derzeit die folgende Informationen in der Nutzlast:</span><span class="sxs-lookup"><span data-stu-id="3c089-144">The XSRF request verification *session token* is stored as an HTTP cookie and currently contains the following information in its payload:</span></span>

- <span data-ttu-id="3c089-145">Ein Sicherheitstoken, bestehend aus eines zufälligen 128-Bit-Bezeichners.</span><span class="sxs-lookup"><span data-stu-id="3c089-145">A security token, consisting of a random 128-bit identifier.</span></span>   
 <span data-ttu-id="3c089-146">Die folgende Abbildung zeigt das XSRF-Anforderung Überprüfung Sitzungstoken, das mit den Internet Explorer F12-Entwicklertools angezeigt: (Beachten Sie dies ist die aktuelle Implementierung und Betreff "," sogar wahrscheinlich, um zu ändern.)</span><span class="sxs-lookup"><span data-stu-id="3c089-146">The following image shows the XSRF request verification session token displayed with the Internet Explorer F12 developer tools: (Note this is the current implementation and is subject, even likely, to change.)</span></span>

![](xsrfcsrf-prevention-in-aspnet-mvc-and-web-pages/_static/image1.png)

<span data-ttu-id="3c089-147">Die *Token Pole* Speicherung als eine `<input type="hidden" />` und enthält die folgende Informationen in der Nutzlast:</span><span class="sxs-lookup"><span data-stu-id="3c089-147">The *field token* is stored as an `<input type="hidden" />` and contains the following information in its payload:</span></span>

- <span data-ttu-id="3c089-148">Benutzername des angemeldeten Benutzers, (wenn authentifiziert).</span><span class="sxs-lookup"><span data-stu-id="3c089-148">The logged-in user's username (if authenticated).</span></span>
- <span data-ttu-id="3c089-149">Zusätzlichen Daten zur Verfügung gestellt, indem ein [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx).</span><span class="sxs-lookup"><span data-stu-id="3c089-149">Any additional data provided by an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx).</span></span>

<span data-ttu-id="3c089-150">Die Nutzlast der Anti-XSRF-Token werden verschlüsselt und signiert, sodass Sie den Benutzernamen nicht anzeigen können, wenn Tools verwenden, um die Token zu überprüfen.</span><span class="sxs-lookup"><span data-stu-id="3c089-150">The payloads of the anti-XSRF tokens are encrypted and signed, so you can't view the username when using tools to examine the tokens.</span></span> <span data-ttu-id="3c089-151">Wenn die Webanwendung ASP.NET 4.0 als Ziel verwendet, finden Sie kryptografische Dienste von der [MachineKey.Encode](https://msdn.microsoft.com/library/system.web.security.machinekey.encode.aspx) Routine.</span><span class="sxs-lookup"><span data-stu-id="3c089-151">When the web application is targeting ASP.NET 4.0, cryptographic services are provided by the [MachineKey.Encode](https://msdn.microsoft.com/library/system.web.security.machinekey.encode.aspx) routine.</span></span> <span data-ttu-id="3c089-152">Wenn die Webanwendung ASP.NET 4.5 ausgerichtet ist, oder höher, kryptografische Dienste werden bereitgestellt, durch die [MachineKey.Protect](https://msdn.microsoft.com/library/system.web.security.machinekey.protect(v=vs.110)) -Routine, die eine bessere Leistung, Erweiterbarkeit und Sicherheit bietet.</span><span class="sxs-lookup"><span data-stu-id="3c089-152">When the web application is targeting ASP.NET 4.5 or higher, cryptographic services are provided by the [MachineKey.Protect](https://msdn.microsoft.com/library/system.web.security.machinekey.protect(v=vs.110)) routine, which offers better performance, extensibility, and security.</span></span> <span data-ttu-id="3c089-153">Feststellen Sie, dass die folgenden Blogbeiträge für Weitere Informationen:</span><span class="sxs-lookup"><span data-stu-id="3c089-153">See the following blog posts for more details:</span></span>

- [<span data-ttu-id="3c089-154">Kryptografischen Verbesserungen in ASP.NET 4.5 "," pt ". 1</span><span class="sxs-lookup"><span data-stu-id="3c089-154">Cryptographic Improvements in ASP.NET 4.5, pt. 1</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/22/cryptographic-improvements-in-asp-net-4-5-pt-1.aspx)
- [<span data-ttu-id="3c089-155">Kryptografischen Verbesserungen in ASP.NET 4.5 "," pt ". 2</span><span class="sxs-lookup"><span data-stu-id="3c089-155">Cryptographic Improvements in ASP.NET 4.5, pt. 2</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/23/cryptographic-improvements-in-asp-net-4-5-pt-2.aspx)
- [<span data-ttu-id="3c089-156">Kryptografischen Verbesserungen in ASP.NET 4.5 "," pt ". 3</span><span class="sxs-lookup"><span data-stu-id="3c089-156">Cryptographic Improvements in ASP.NET 4.5, pt. 3</span></span>](https://blogs.msdn.com/b/webdev/archive/2012/10/24/cryptographic-improvements-in-asp-net-4-5-pt-3.aspx)

## <a name="generating-the-tokens"></a><span data-ttu-id="3c089-157">Generieren von Token</span><span class="sxs-lookup"><span data-stu-id="3c089-157">Generating the tokens</span></span>

<span data-ttu-id="3c089-158">Um die Anti-XSRF-Token zu generieren, rufen die [ @Html.AntiForgeryToken ](https://msdn.microsoft.com/library/dd470175.aspx) Methode aus einer MVC-Ansicht oder @AntiForgery.GetHtml() aus einer Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="3c089-158">To generate the anti-XSRF tokens, call the [@Html.AntiForgeryToken](https://msdn.microsoft.com/library/dd470175.aspx) method from an MVC view or @AntiForgery.GetHtml() from a Razor page.</span></span> <span data-ttu-id="3c089-159">Die Common Language Runtime führt dann die folgenden Schritte aus:</span><span class="sxs-lookup"><span data-stu-id="3c089-159">The runtime will then perform the following steps:</span></span>

1. <span data-ttu-id="3c089-160">Wenn die aktuelle HTTP-Anforderung bereits ein Anti-XSRF-Sitzungstoken enthält (Anti-XSRF-Cookies \_ \_RequestVerificationToken), das Sicherheitstoken wird daraus extrahiert.</span><span class="sxs-lookup"><span data-stu-id="3c089-160">If the current HTTP request already contains an anti-XSRF session token (the anti-XSRF cookie \_\_RequestVerificationToken), the security token is extracted from it.</span></span> <span data-ttu-id="3c089-161">Wenn die HTTP-Anforderung ein Anti-XSRF-Sitzungstoken nicht enthält oder wenn der Fehler bei der Extraktion des Sicherheitstokens, ein neues zufälliges Anti-XSRF-Token generiert werden.</span><span class="sxs-lookup"><span data-stu-id="3c089-161">If the HTTP request does not contain an anti-XSRF session token or if extraction of the security token fails, a new random anti-XSRF token will be generated.</span></span>
2. <span data-ttu-id="3c089-162">Ein Feld Anti-XSRF-Token wird mithilfe des Sicherheitstokens aus den vorherigen Schritt (1) und die Identität des aktuellen Benutzers angemeldet generiert.</span><span class="sxs-lookup"><span data-stu-id="3c089-162">An anti-XSRF field token is generated using the security token from step (1) above and the identity of the current logged-in user.</span></span> <span data-ttu-id="3c089-163">(Weitere Informationen zum Ermitteln der Identität des Benutzers finden Sie unter den **[Szenarien mit besonderer Unterstützung](#_Scenarios_with_special)** Abschnitt weiter unten.) Darüber hinaus Wenn ein [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/jj158328(v=vs.111).aspx) ist konfiguriert, die Laufzeit ruft die [GetAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.getadditionaldata(v=vs.111).aspx) Methode und die zurückgegebene Zeichenfolge im Feldtoken enthalten.</span><span class="sxs-lookup"><span data-stu-id="3c089-163">(For more information on determining user identity, see the **[Scenarios with special support](#_Scenarios_with_special)** section below.) Additionally, if an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/jj158328(v=vs.111).aspx) is configured, the runtime will call its [GetAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.getadditionaldata(v=vs.111).aspx) method and include the returned string in the field token.</span></span> <span data-ttu-id="3c089-164">(Finden Sie unter den **[Konfiguration und Erweiterbarkeit](#_Configuration_and_extensibility)** Abschnitt, um weitere Informationen.)</span><span class="sxs-lookup"><span data-stu-id="3c089-164">(See the **[Configuration and extensibility](#_Configuration_and_extensibility)** section for more information.)</span></span>
3. <span data-ttu-id="3c089-165">Wenn in Schritt (1) ein neues Anti-XSRF-Token generiert wurde, wird ein neues Sitzungstoken dafür erstellt werden und wird der ausgehenden HTTP-Cookies-Auflistung hinzugefügt werden.</span><span class="sxs-lookup"><span data-stu-id="3c089-165">If a new anti-XSRF token was generated in step (1), a new session token will be created to contain it and will be added to the outbound HTTP cookies collection.</span></span> <span data-ttu-id="3c089-166">Wird das Feldtoken aus Schritt (2) umschlossen werden ein `<input type="hidden" />` Element, und diese HTML-Markup wird der Rückgabewert von `Html.AntiForgeryToken()` oder `AntiForgery.GetHtml()`.</span><span class="sxs-lookup"><span data-stu-id="3c089-166">The field token from step (2) will be wrapped in an `<input type="hidden" />` element, and this HTML markup will be the return value of `Html.AntiForgeryToken()` or `AntiForgery.GetHtml()`.</span></span>

## <a name="validating-the-tokens"></a><span data-ttu-id="3c089-167">Überprüfen von Token</span><span class="sxs-lookup"><span data-stu-id="3c089-167">Validating the tokens</span></span>

<span data-ttu-id="3c089-168">Um die eingehenden Anti-XSRF-Token zu überprüfen, die Entwickler umfasst eine [ValidateAntiForgeryToken](https://msdn.microsoft.com/library/system.web.mvc.validateantiforgerytokenattribute(VS.108).aspx) Attribut für ihre MVC-Aktion oder des Controllers oder She Aufrufe `@AntiForgery.Validate()` aus ihrem Razor Pages.</span><span class="sxs-lookup"><span data-stu-id="3c089-168">To validate the incoming anti-XSRF tokens, the developer includes a [ValidateAntiForgeryToken](https://msdn.microsoft.com/library/system.web.mvc.validateantiforgerytokenattribute(VS.108).aspx) attribute on her MVC action or controller, or she calls `@AntiForgery.Validate()` from her Razor page.</span></span> <span data-ttu-id="3c089-169">Die Laufzeit führt die folgenden Schritte aus:</span><span class="sxs-lookup"><span data-stu-id="3c089-169">The runtime will perform the following steps:</span></span>

1. <span data-ttu-id="3c089-170">Die eingehenden Sitzungstokens und Feldtoken werden gelesen, und die Anti-XSRF-Token extrahiert aus jedem.</span><span class="sxs-lookup"><span data-stu-id="3c089-170">The incoming session token and field token are read and the anti-XSRF token extracted from each.</span></span> <span data-ttu-id="3c089-171">Die Anti-XSRF-Token müssen pro Schritt (2) in der Routine Generation identisch sein.</span><span class="sxs-lookup"><span data-stu-id="3c089-171">The anti-XSRF tokens must be identical per step (2) in the generation routine.</span></span>
2. <span data-ttu-id="3c089-172">Wenn der aktuelle Benutzer authentifiziert ist, wird der Benutzernamen mit dem Benutzernamen in das Feldtoken gespeicherten verglichen.</span><span class="sxs-lookup"><span data-stu-id="3c089-172">If the current user is authenticated, her username is compared with the username stored in the field token.</span></span> <span data-ttu-id="3c089-173">Benutzernamen müssen übereinstimmen.</span><span class="sxs-lookup"><span data-stu-id="3c089-173">The usernames must match.</span></span>
3. <span data-ttu-id="3c089-174">Wenn ein [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) konfiguriert ist, ruft die Laufzeit die *ValidateAdditionalData* Methode.</span><span class="sxs-lookup"><span data-stu-id="3c089-174">If an [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) is configured, the runtime calls its *ValidateAdditionalData* method.</span></span> <span data-ttu-id="3c089-175">Die Methode muss den booleschen Wert zurückgeben *"true"*.</span><span class="sxs-lookup"><span data-stu-id="3c089-175">The method must return the Boolean value *true*.</span></span>

<span data-ttu-id="3c089-176">Wenn die Überprüfung erfolgreich ist, ist die Anforderung zulässig, um den Vorgang fortzusetzen.</span><span class="sxs-lookup"><span data-stu-id="3c089-176">If validation succeeds, the request is allowed to proceed.</span></span> <span data-ttu-id="3c089-177">Wenn die Validierung fehlschlägt, löst das Framework eine *HttpAntiForgeryException*.</span><span class="sxs-lookup"><span data-stu-id="3c089-177">If validation fails, the framework will throw an *HttpAntiForgeryException*.</span></span>

## <a name="failure-conditions"></a><span data-ttu-id="3c089-178">Fehlerbedingungen</span><span class="sxs-lookup"><span data-stu-id="3c089-178">Failure conditions</span></span>

<span data-ttu-id="3c089-179">Ab der ASP.NET Web Stack Runtime v2, alle *HttpAntiForgeryException* ausgelöst, während der Validierung enthält ausführliche Informationen zum Problem geöffnet.</span><span class="sxs-lookup"><span data-stu-id="3c089-179">Starting with The ASP.NET Web Stack Runtime v2, any *HttpAntiForgeryException* that is thrown during validation will contain detailed information about what went wrong.</span></span> <span data-ttu-id="3c089-180">Die aktuell definierten fehlerbedingungen sind:</span><span class="sxs-lookup"><span data-stu-id="3c089-180">The currently defined failure conditions are:</span></span>

- <span data-ttu-id="3c089-181">Das Sitzungstoken, das oder formulartoken ist nicht in der Anforderung vorhanden.</span><span class="sxs-lookup"><span data-stu-id="3c089-181">The session token or form token is not present in the request.</span></span>
- <span data-ttu-id="3c089-182">Das Sitzungstoken, das oder die formulartoken kann nicht gelesen werden.</span><span class="sxs-lookup"><span data-stu-id="3c089-182">The session token or form token is unreadable.</span></span> <span data-ttu-id="3c089-183">Die wahrscheinlichste Ursache dieser ist eine nicht übereinstimmende Versionen von der ASP.NET Web Stack Runtime oder in einer Farm-Farm, in denen die &lt;MachineKey&gt; Element in "Web.config" unterscheidet sich zwischen Computern.</span><span class="sxs-lookup"><span data-stu-id="3c089-183">The most likely cause of this is a farm running mismatched versions of The ASP.NET Web Stack Runtime or a farm where the &lt;machineKey&gt; element in Web.config differs between machines.</span></span> <span data-ttu-id="3c089-184">Sie können ein Tool wie Fiddler verwenden, um diese Ausnahme zu erzwingen, indem Sie die Manipulation von beiden Anti-XSRF-Token.</span><span class="sxs-lookup"><span data-stu-id="3c089-184">You can use a tool such as Fiddler to force this exception by tampering with either anti-XSRF token.</span></span>
- <span data-ttu-id="3c089-185">Das Sitzungstoken und Feldtoken wurden ausgetauscht.</span><span class="sxs-lookup"><span data-stu-id="3c089-185">The session token and field token were swapped.</span></span>
- <span data-ttu-id="3c089-186">Das Sitzungstoken und Feldtoken enthalten, nicht übereinstimmende Sicherheitstoken.</span><span class="sxs-lookup"><span data-stu-id="3c089-186">The session token and field token contain mismatched security tokens.</span></span>
- <span data-ttu-id="3c089-187">Der Benutzername, der in das Feldtoken eingebettet entspricht nicht den angemeldeten Benutzernamen des aktuellen Benutzers.</span><span class="sxs-lookup"><span data-stu-id="3c089-187">The username embedded within the field token does not match the current logged-in user's username.</span></span>
- <span data-ttu-id="3c089-188">Die *[IAntiForgeryAdditionalDataProvider.ValidateAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.validateadditionaldata(v=vs.111).aspx)* zurückgegebene Methode *"false"*.</span><span class="sxs-lookup"><span data-stu-id="3c089-188">The *[IAntiForgeryAdditionalDataProvider.ValidateAdditionalData](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider.validateadditionaldata(v=vs.111).aspx)* method returned *false*.</span></span>

<span data-ttu-id="3c089-189">Die Anti-XSRF-Funktionen können auch führen zusätzliche Überprüfungen während der Generierung von Tokens oder die Überprüfung durch, und Fehler während der diese Überprüfungen möglicherweise ausgelösten Ausnahmen.</span><span class="sxs-lookup"><span data-stu-id="3c089-189">The anti-XSRF facilities may also perform additional checking during token generation or validation, and failures during these checks may result in exceptions being thrown.</span></span> <span data-ttu-id="3c089-190">Finden Sie unter den [WIF / ACS / Claims-basierte Authentifizierung](#_WIF_ACS) und **[Konfiguration und Erweiterbarkeit](#_Configuration_and_extensibility)** Abschnitten Weitere Informationen.</span><span class="sxs-lookup"><span data-stu-id="3c089-190">See the [WIF / ACS / claims-based authentication](#_WIF_ACS) and **[Configuration and extensibility](#_Configuration_and_extensibility)** sections for more information.</span></span>

<a id="_Scenarios_with_special"></a>

## <a name="scenarios-with-special-support"></a><span data-ttu-id="3c089-191">Szenarien mit besonderer Unterstützung</span><span class="sxs-lookup"><span data-stu-id="3c089-191">Scenarios with special support</span></span>

### <a name="anonymous-authentication"></a><span data-ttu-id="3c089-192">Anonyme Authentifizierung</span><span class="sxs-lookup"><span data-stu-id="3c089-192">Anonymous authentication</span></span>

<span data-ttu-id="3c089-193">Die Anti-XSRF-enthält spezielle Unterstützung für anonyme Benutzer, wobei "Anonym" als Benutzer definiert ist, in denen die *IIdentity.IsAuthenticated* -Eigenschaft gibt *"false"*.</span><span class="sxs-lookup"><span data-stu-id="3c089-193">The anti-XSRF system contains special support for anonymous users, where "anonymous" is defined as a user where the *IIdentity.IsAuthenticated* property returns *false*.</span></span> <span data-ttu-id="3c089-194">Szenarien gehört die Bereitstellung von XSRF-Schutz auf die Anmeldeseite (bevor der Benutzer authentifiziert ist) und benutzerdefinierte Authentifizierungsschemas, bei denen die Anwendung einen Mechanismus außer verwendet *IIdentity* zur Identifizierung von Benutzern.</span><span class="sxs-lookup"><span data-stu-id="3c089-194">Scenarios include providing XSRF protection to the login page (before the user is authenticated) and custom authentication schemes where the application uses a mechanism other than *IIdentity* to identify users.</span></span>

<span data-ttu-id="3c089-195">Um diese Szenarien zu unterstützen, denken Sie daran, dass die Sitzung und Feld-Token ein Sicherheitstoken, verknüpft sind, die eine 128-Bit-zufällig generierten opaque-Bezeichner ist.</span><span class="sxs-lookup"><span data-stu-id="3c089-195">To support these scenarios, recall that the session and field tokens are joined by a security token, which is a 128-bit randomly-generated opaque identifier.</span></span> <span data-ttu-id="3c089-196">Dieses Sicherheitstoken wird verwendet, um eine einzelne benutzersitzung nachzuverfolgen, wie sie die Website navigiert, damit sie effektiv den Zweck der einen anonymen Bezeichner dient.</span><span class="sxs-lookup"><span data-stu-id="3c089-196">This security token is used to track an individual user's session as she navigates the site, so it effectively serves the purpose of an anonymous identifier.</span></span> <span data-ttu-id="3c089-197">Eine leere Zeichenfolge wird anstelle der Benutzername für die Generierung und Überprüfung Routinen, die oben beschriebenen verwendet.</span><span class="sxs-lookup"><span data-stu-id="3c089-197">An empty string is used in place of the username for the generation and validation routines described above.</span></span>

<a id="_WIF_ACS"></a>

### <a name="wif--acs--claims-based-authentication"></a><span data-ttu-id="3c089-198">WIF / ACS / Claims-basierte Authentifizierung</span><span class="sxs-lookup"><span data-stu-id="3c089-198">WIF / ACS / claims-based authentication</span></span>

<span data-ttu-id="3c089-199">In der Regel die *IIdentity* Klassen, die in .NET Framework integriert haben, die Eigenschaft, die *IIdentity.Name* ist ausreichend, um einen bestimmten Benutzer innerhalb einer bestimmten Anwendung eindeutig zu identifizieren.</span><span class="sxs-lookup"><span data-stu-id="3c089-199">Normally, the *IIdentity* classes built in to the .NET Framework have the property that *IIdentity.Name* is sufficient to uniquely identify a particular user within a particular application.</span></span> <span data-ttu-id="3c089-200">Z. B. *FormsIdentity.Name* gibt den Benutzernamen, die in der Mitgliedschaftsdatenbank (die für alle Anwendungen, die abhängig von der Datenbank eindeutig ist), gespeicherte *WindowsIdentity.Name* gibt die domänenqualifizierte Identität des Benutzers, und So weiter.</span><span class="sxs-lookup"><span data-stu-id="3c089-200">For example, *FormsIdentity.Name* returns the username stored in the membership database (which is unique for all applications depending on that database), *WindowsIdentity.Name* returns the domain-qualified identity of the user, and so on.</span></span> <span data-ttu-id="3c089-201">Diese Systeme bieten nicht nur die Authentifizierung; Diese auch *identifizieren* Benutzern für eine Anwendung.</span><span class="sxs-lookup"><span data-stu-id="3c089-201">These systems provide not only authentication; they also *identify* users to an application.</span></span>

<span data-ttu-id="3c089-202">Claims-basierte Authentifizierung ist auf der anderen Seite nicht unbedingt erforderlich, die einen bestimmten Benutzer identifiziert.</span><span class="sxs-lookup"><span data-stu-id="3c089-202">Claims-based authentication, on the other hand, does not necessarily require identifying a particular user.</span></span> <span data-ttu-id="3c089-203">Stattdessen die *"ClaimsPrincipal"* und *"ClaimsIdentity"* Typen sind verknüpft mit einem Satz von *Anspruch* -Instanzen, in denen die einzelnen Ansprüche möglicherweise "über 18 Jahre alt ist" oder " ist ein Administrator"zu einem anderen.</span><span class="sxs-lookup"><span data-stu-id="3c089-203">Instead, the *ClaimsPrincipal* and *ClaimsIdentity* types are associated with a set of *Claim* instances, where the individual claims might be "is 18+ years of age" or "is an administrator" to anything else.</span></span> <span data-ttu-id="3c089-204">Da der Benutzer noch nicht unbedingt identifiziert wurde, kann die Runtime nicht verwenden die *ClaimsIdentity.Name* Eigenschaft als eindeutiger Bezeichner für diesen Benutzer.</span><span class="sxs-lookup"><span data-stu-id="3c089-204">Since the user hasn't necessarily been identified, the runtime cannot use the *ClaimsIdentity.Name* property as a unique identifier for this particular user.</span></span> <span data-ttu-id="3c089-205">Das Team kann angezeigt werden, praktische Beispiele, in denen *ClaimsIdentity.Name* gibt *null*, gibt einen Anzeigenamen (anzeigen) oder eine Zeichenfolge, die nicht geeignet für die Verwendung als eindeutiger Bezeichner ist, andernfalls für den Benutzer.</span><span class="sxs-lookup"><span data-stu-id="3c089-205">The team has seen real-world examples where *ClaimsIdentity.Name* returns *null*, returns a friendly (display) name, or otherwise returns a string that isn't appropriate for use as a unique identifier for the user.</span></span>

<span data-ttu-id="3c089-206">Viele der Bereitstellungen, die anspruchsbasierte Authentifizierung verwenden [Azure Access Control Service](https://msdn.microsoft.com/library/windowsazure/gg429786.aspx) (ACS) insbesondere.</span><span class="sxs-lookup"><span data-stu-id="3c089-206">Many of deployments which use claims-based authentication are using [Azure Access Control Service](https://msdn.microsoft.com/library/windowsazure/gg429786.aspx) (ACS) in particular.</span></span> <span data-ttu-id="3c089-207">ACS ermöglicht es dem Entwickler so konfigurieren Sie einzelne *Identitätsanbieter* (z. B. ADFS, der Microsoft-Account-Anbieter, OpenID-Anbietern wie Yahoo! usw.), und geben Sie die Identitätsanbieter zurück *Bezeichnerbenennen*.</span><span class="sxs-lookup"><span data-stu-id="3c089-207">ACS allows the developer to configure individual *identity providers* (such as ADFS, the Microsoft Account provider, OpenID providers like Yahoo!, etc.), and the identity providers return *name identifiers*.</span></span> <span data-ttu-id="3c089-208">Diese Name-Bezeichner können Daten mit persönlich identifizierbaren Informationen (PII) enthalten, z. B. eine e-Mail-Adresse, oder sie können z. B. eine Private persönliche Bezeichner (PPID) anonymisiert werden.</span><span class="sxs-lookup"><span data-stu-id="3c089-208">These name identifiers may contain Personally Identifiable Information (PII) like an email address, or they could be anonymized like a Private Personal Identifier (PPID).</span></span> <span data-ttu-id="3c089-209">Unabhängig davon, das Tupel (Identitätsanbieter, den Namensbezeichner) ausreichend dient als entsprechenden Token für einen bestimmten Benutzer, während sie den Standort, damit die ASP.NET Web-Stack-Laufzeit das Tupel anstelle des Benutzernamens, beim Generieren von verwenden können durchsucht und Überprüfen von Anti-XSRF-Feld-Token.</span><span class="sxs-lookup"><span data-stu-id="3c089-209">Regardless, the tuple (identity provider, name identifier) sufficiently serves as an appropriate tracking token for a particular user while she is browsing the site, so the ASP.NET Web Stack Runtime can use the tuple in place of the username when generating and validating anti-XSRF field tokens.</span></span> <span data-ttu-id="3c089-210">Die bestimmte URIs für den betreffenden Identitätsanbieter anzeigt und die Name-ID sind:</span><span class="sxs-lookup"><span data-stu-id="3c089-210">The particular URIs for the identity provider and the name identifier are :</span></span>

- `http://schemas.microsoft.com/accesscontrolservice/2010/07/claims/identityprovider`
- `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier`

<span data-ttu-id="3c089-211">(finden Sie in diesem [ACS Doc Seite](https://msdn.microsoft.com/library/windowsazure/gg185971.aspx) für Weitere Informationen.)</span><span class="sxs-lookup"><span data-stu-id="3c089-211">(see this [ACS doc page](https://msdn.microsoft.com/library/windowsazure/gg185971.aspx) for more info.)</span></span>

<span data-ttu-id="3c089-212">Beim generieren, oder Überprüfen eines Tokens, die ASP.NET Web Stack Laufzeit versucht zur Laufzeit Bindung an Typen:</span><span class="sxs-lookup"><span data-stu-id="3c089-212">When generating or validating a token, the ASP.NET Web Stack Runtime will at runtime try binding to the types:</span></span>

- <span data-ttu-id="3c089-213">`Microsoft.IdentityModel.Claims.IClaimsIdentity, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35` (Für die WIF-SDK).</span><span class="sxs-lookup"><span data-stu-id="3c089-213">`Microsoft.IdentityModel.Claims.IClaimsIdentity, Microsoft.IdentityModel, Version=3.5.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35` (For the WIF SDK.)</span></span>
- <span data-ttu-id="3c089-214">`System.Security.Claims.ClaimsIdentity` (Für .NET 4.5).</span><span class="sxs-lookup"><span data-stu-id="3c089-214">`System.Security.Claims.ClaimsIdentity` (For .NET 4.5).</span></span>

<span data-ttu-id="3c089-215">Wenn diese Typen sind vorhanden und des aktuellen Benutzers *IIIIdentity* implementiert oder Unterklassen eines der folgenden Typen ist, der Anti-XSRF-Funktion (Identitätsanbieter, den Namensbezeichner) Tupel anstelle der Benutzername beim Generieren von und Überprüfen die Token an.</span><span class="sxs-lookup"><span data-stu-id="3c089-215">If these types exist, and if the current user's *IIIIdentity* implements or subclasses one of these types, the anti-XSRF facility will use the (identity provider, name identifier) tuple in place of the username when generating and validating the tokens.</span></span> <span data-ttu-id="3c089-216">Wenn kein solcher Tupel vorhanden ist, schlägt die Anforderung mit der Fehlermeldung beschreibt das für den Entwickler zum Konfigurieren des Anti-XSRF-Systems, um zu verstehen, den bestimmte anspruchsbasierten Authentifizierungsmechanismus verwendet fehl.</span><span class="sxs-lookup"><span data-stu-id="3c089-216">If no such tuple is present, the request will fail with an error describing to the developer how to configure the anti-XSRF system to understand the particular claims-based authentication mechanism in use.</span></span> <span data-ttu-id="3c089-217">Finden Sie unter den **[Konfiguration und Erweiterbarkeit](#_Configuration_and_extensibility)** Abschnitt, um weitere Informationen.</span><span class="sxs-lookup"><span data-stu-id="3c089-217">See the **[Configuration and extensibility](#_Configuration_and_extensibility)** section for more information.</span></span>

### <a name="oauth--openid-authentication"></a><span data-ttu-id="3c089-218">OAuth / OpenID-Authentifizierung</span><span class="sxs-lookup"><span data-stu-id="3c089-218">OAuth / OpenID authentication</span></span>

<span data-ttu-id="3c089-219">Schließlich verfügt die Anti-XSRF-Funktion spezielle Unterstützung für Anwendungen, die OAuth- oder OpenID-Authentifizierung verwenden.</span><span class="sxs-lookup"><span data-stu-id="3c089-219">Finally, the anti-XSRF facility has special support for applications which use OAuth or OpenID authentication.</span></span> <span data-ttu-id="3c089-220">Diese Unterstützung basiert auf Heuristik: Wenn die aktuelle *IIdentity.Name* beginnt mit http:// oder https://, dann Benutzernamen Vergleiche erfolgen statt einen ordinalen Vergleich der OrdinalIgnoreCase Standardvergleich.</span><span class="sxs-lookup"><span data-stu-id="3c089-220">This support is heuristic-based: if the current *IIdentity.Name* begins with http:// or https://, then username comparisons will be done using an Ordinal comparer rather than the default OrdinalIgnoreCase comparer.</span></span>

<a id="_Configuration_and_extensibility"></a>

## <a name="configuration-and-extensibility"></a><span data-ttu-id="3c089-221">Konfiguration und Erweiterbarkeit</span><span class="sxs-lookup"><span data-stu-id="3c089-221">Configuration and extensibility</span></span>

<span data-ttu-id="3c089-222">In einigen Fällen möchten Entwickler möglicherweise eine bessere Kontrolle über die Anti-XSRF-Generierung und Überprüfung Verhalten.</span><span class="sxs-lookup"><span data-stu-id="3c089-222">Occasionally, developers may want tighter control over the anti-XSRF generation and validation behaviors.</span></span> <span data-ttu-id="3c089-223">Z. B. möglicherweise die MVC und Web Pages-Hilfsprogramme Standardverhalten Automatisches Hinzufügen von HTTP-Cookies an die Antwort nicht erwünscht ist, und der Entwickler möglicherweise möchten Sie die Token an anderer Stelle beizubehalten.</span><span class="sxs-lookup"><span data-stu-id="3c089-223">For example, perhaps the MVC and Web Pages helpers' default behavior of automatically adding HTTP cookies to the response is undesirable, and the developer may wish to persist the tokens elsewhere.</span></span> <span data-ttu-id="3c089-224">Vorhanden sind zwei APIs, um dies zu unterstützen:</span><span class="sxs-lookup"><span data-stu-id="3c089-224">There exist two APIs to assist with this:</span></span>

`AntiForgery.GetTokens(string oldCookieToken, out string newCookieToken, out string formToken);`  
`AntiForgery.Validate(string cookieToken, string formToken);`

<span data-ttu-id="3c089-225">Die *GetTokens* Methode nimmt als Eingabe ein vorhandenes XSRF-Anforderung Überprüfung Sitzungstoken (der null sein kann) und wird als Ausgabe eine neue XSRF-Anforderung Überprüfung Sitzungstoken und Feldtoken.</span><span class="sxs-lookup"><span data-stu-id="3c089-225">The *GetTokens* method takes as input an existing XSRF request verification session token (which may be null) and produces as output a new XSRF request verification session token and field token.</span></span> <span data-ttu-id="3c089-226">Die Token sind einfach opake Zeichenfolgen ohne Dekoration; die *FormToken* Wert wird für die Instanz nicht umschlossen werden ein &lt;Eingabe&gt; Tag.</span><span class="sxs-lookup"><span data-stu-id="3c089-226">The tokens are simply opaque strings with no decoration; the *formToken* value will for instance not be wrapped in an &lt;input&gt; tag.</span></span> <span data-ttu-id="3c089-227">Die *NewCookieToken* Wert ist möglicherweise null ist; in diesem Fall wird die *OldCookieToken* Wert immer noch gültig ist und kein neues Antwortcookie muss festgelegt werden.</span><span class="sxs-lookup"><span data-stu-id="3c089-227">The *newCookieToken* value may be null; if this occurs, then the *oldCookieToken* value is still valid and no new response cookie need be set.</span></span> <span data-ttu-id="3c089-228">Der Aufrufer *GetTokens* ist verantwortlich für alle erforderlichen Antwortcookies beibehalten oder generieren alle notwendigen Markups; die *GetTokens* Methode selbst wirkt sich nicht auf die Antwort als Nebeneffekt.</span><span class="sxs-lookup"><span data-stu-id="3c089-228">The caller of *GetTokens* is responsible for persisting any necessary response cookies or generating any necessary markup; the *GetTokens* method itself will not alter the response as a side effect.</span></span> <span data-ttu-id="3c089-229">Die *überprüfen* Methode akzeptiert die eingehende Sitzung und Feld-Token und die oben genannten Validierungslogik durchläuft.</span><span class="sxs-lookup"><span data-stu-id="3c089-229">The *Validate* method takes the incoming session and field tokens and runs the aforementioned validation logic over them.</span></span>

### <a name="antiforgeryconfig"></a><span data-ttu-id="3c089-230">AntiForgeryConfig</span><span class="sxs-lookup"><span data-stu-id="3c089-230">AntiForgeryConfig</span></span>

<span data-ttu-id="3c089-231">Der Entwickler kann das System Anti-XSRF-Anwendung konfigurieren\_starten.</span><span class="sxs-lookup"><span data-stu-id="3c089-231">The developer may configure the anti-XSRF system from Application\_Start.</span></span> <span data-ttu-id="3c089-232">Die Konfiguration ist die programmgesteuerte.</span><span class="sxs-lookup"><span data-stu-id="3c089-232">Configuration is programmatic.</span></span> <span data-ttu-id="3c089-233">Die Eigenschaften der statischen *AntiForgeryConfig* Typ werden unten beschrieben.</span><span class="sxs-lookup"><span data-stu-id="3c089-233">The properties of the static *AntiForgeryConfig* type are described below.</span></span> <span data-ttu-id="3c089-234">Die meisten Benutzer, die Ansprüche verwenden sollten, die UniqueClaimTypeIdentifier-Eigenschaft festzulegen.</span><span class="sxs-lookup"><span data-stu-id="3c089-234">Most users using claims will want to set the UniqueClaimTypeIdentifier property.</span></span>

| <span data-ttu-id="3c089-235">**Property**</span><span class="sxs-lookup"><span data-stu-id="3c089-235">**Property**</span></span> | <span data-ttu-id="3c089-236">**Beschreibung**</span><span class="sxs-lookup"><span data-stu-id="3c089-236">**Description**</span></span> |
| --- | --- |
| <span data-ttu-id="3c089-237">**AdditionalDataProvider**</span><span class="sxs-lookup"><span data-stu-id="3c089-237">**AdditionalDataProvider**</span></span> | <span data-ttu-id="3c089-238">Ein [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) , stellt zusätzliche Daten während der Generierung von Tokens und zusätzliche Daten während der Validierung von token verwendet.</span><span class="sxs-lookup"><span data-stu-id="3c089-238">An [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) that provides additional data during token generation and consumes additional data during token validation.</span></span> <span data-ttu-id="3c089-239">Der Standardwert ist *null*.</span><span class="sxs-lookup"><span data-stu-id="3c089-239">The default value is *null*.</span></span> <span data-ttu-id="3c089-240">Weitere Informationen finden Sie unter den [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="3c089-240">For more information, see the [IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx) section.</span></span> |
| <span data-ttu-id="3c089-241">**CookieName**</span><span class="sxs-lookup"><span data-stu-id="3c089-241">**CookieName**</span></span> | <span data-ttu-id="3c089-242">Eine Zeichenfolge, die den Namen des HTTP-Cookies bereitstellt, die zum Speichern der Anti-XSRF-Sitzungstoken verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="3c089-242">A string that provides the name of the HTTP cookie that is used to store the anti-XSRF session token.</span></span> <span data-ttu-id="3c089-243">Wenn dieser Wert nicht festgelegt ist, wird ein Name automatisch basierend auf der Anwendung bereitgestellten virtuellen Pfad generiert werden.</span><span class="sxs-lookup"><span data-stu-id="3c089-243">If this value is not set, a name will be automatically generated based on the application's deployed virtual path.</span></span> <span data-ttu-id="3c089-244">Der Standardwert ist *null*.</span><span class="sxs-lookup"><span data-stu-id="3c089-244">The default value is *null*.</span></span> |
| <span data-ttu-id="3c089-245">**RequireSsl**</span><span class="sxs-lookup"><span data-stu-id="3c089-245">**RequireSsl**</span></span> | <span data-ttu-id="3c089-246">Ein boolescher Wert, der angibt, ob die Anti-XSRF-Token über einen SSL-gesicherten Kanal gesendet werden müssen.</span><span class="sxs-lookup"><span data-stu-id="3c089-246">A Boolean that dictates whether the anti-XSRF tokens are required to be submitted over an SSL-secured channel.</span></span> <span data-ttu-id="3c089-247">Wenn dieser Wert ist *"true"*, alle automatisch generierten Cookies müssen die "secure" Kennzeichen festgelegt, und die Anti-XSRF-APIs löst aus, wenn Sie von innerhalb einer Anforderung aufgerufen wird, die nicht über SSL gesendet wird.</span><span class="sxs-lookup"><span data-stu-id="3c089-247">If this value is *true*, any automatically-generated cookies will have the "secure" flag set, and the anti-XSRF APIs will throw if called from within a request that is not submitted via SSL.</span></span> <span data-ttu-id="3c089-248">Der Standardwert ist *FALSE*.</span><span class="sxs-lookup"><span data-stu-id="3c089-248">The default value is *false*.</span></span> |
| <span data-ttu-id="3c089-249">**SuppressIdentityHeuristicChecks**</span><span class="sxs-lookup"><span data-stu-id="3c089-249">**SuppressIdentityHeuristicChecks**</span></span> | <span data-ttu-id="3c089-250">Ein boolescher Wert, der angibt, ob die Anti-XSRF-System die Unterstützung für anspruchsbasierte Identitäten deaktiviert werden soll.</span><span class="sxs-lookup"><span data-stu-id="3c089-250">A Boolean that dictates whether the anti-XSRF system should deactivate its support for claims-based identities.</span></span> <span data-ttu-id="3c089-251">Wenn dieser Wert ist *"true"*, geht das System davon aus, die *IIdentity.Name* eignet sich für die Verwendung als eine eindeutige pro-Benutzer-ID und versucht nicht, besondere Schreibweisen *IClaimsIdentity*oder *ClClaimsIdentity* wie beschrieben in der [WIF / ACS / Claims-basierte Authentifizierung](#_WIF_ACS) Abschnitt.</span><span class="sxs-lookup"><span data-stu-id="3c089-251">If this value is *true*, the system will assume that *IIdentity.Name* is appropriate for use as a unique per-user identifier and will not try to special-case *IClaimsIdentity* or *ClClaimsIdentity* as described in the [WIF / ACS / claims-based authentication](#_WIF_ACS) section.</span></span> <span data-ttu-id="3c089-252">Der Standardwert ist `false`.</span><span class="sxs-lookup"><span data-stu-id="3c089-252">The default value is `false`.</span></span> |
| <span data-ttu-id="3c089-253">**UniqueClaimTypeIdentifier**</span><span class="sxs-lookup"><span data-stu-id="3c089-253">**UniqueClaimTypeIdentifier**</span></span> | <span data-ttu-id="3c089-254">Eine Zeichenfolge, die angibt, welcher Anspruchstyp eignet sich für die Verwendung als eine eindeutige pro-Benutzer-ID.</span><span class="sxs-lookup"><span data-stu-id="3c089-254">A string that indicates which claim type is appropriate for use as a unique per-user identifier.</span></span> <span data-ttu-id="3c089-255">Wenn dieser Wert Satz und der aktuelle *IIdentity* wird angegeben, wird versucht, einen Anspruch des Typs zu extrahieren, Claims-basierte *UniqueClaimTypeIdentifier*, und der entsprechende Wert verwendet werden anstelle den Benutzernamen des Benutzers beim Generieren der Feld-Token.</span><span class="sxs-lookup"><span data-stu-id="3c089-255">If this value is set and the current *IIdentity* is claims-based, the system will attempt to extract a claim of the type specified by *UniqueClaimTypeIdentifier*, and the corresponding value will be used in place of the user's username when generating the field token.</span></span> <span data-ttu-id="3c089-256">Wenn Sie der Anspruchstyp "" nicht gefunden wird, wird das System die Anforderung fehl.</span><span class="sxs-lookup"><span data-stu-id="3c089-256">If the claim type is not found, the system will fail the request.</span></span> <span data-ttu-id="3c089-257">Der Standardwert ist *null*, die angibt, dass das System zu verwendende (Identitätsanbieter, den Namensbezeichner) Tupel anstelle der Benutzername des Benutzers wie zuvor beschrieben.</span><span class="sxs-lookup"><span data-stu-id="3c089-257">The default value is *null*, which indicates that the system should use the (identity provider, name identifier) tuple as previously described in place of the user's username.</span></span> |

<a id="_IAntiForgeryAdditionalDataProvider"></a>

### <a name="iantiforgeryadditionaldataprovider"></a><span data-ttu-id="3c089-258">IAntiForgeryAdditionalDataProvider</span><span class="sxs-lookup"><span data-stu-id="3c089-258">IAntiForgeryAdditionalDataProvider</span></span>

<span data-ttu-id="3c089-259">Die *[IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx)* Typ ermöglicht Entwicklern, die das Verhalten des Anti-XSRF-Systems durch zusätzliche Round-Tripping-Daten in jedem Token zu erweitern.</span><span class="sxs-lookup"><span data-stu-id="3c089-259">The *[IAntiForgeryAdditionalDataProvider](https://msdn.microsoft.com/library/system.web.helpers.iantiforgeryadditionaldataprovider(v=vs.111).aspx)* type allows developers to extend the behavior of the anti-XSRF system by round-tripping additional data in each token.</span></span> <span data-ttu-id="3c089-260">Die *GetAdditionalData* Methode jedes Mal aufgerufen, wird ein Token generiert und der zurückgegebene Wert in das generierte Token eingebettet ist.</span><span class="sxs-lookup"><span data-stu-id="3c089-260">The *GetAdditionalData* method is called each time a field token is generated, and the return value is embedded within the generated token.</span></span> <span data-ttu-id="3c089-261">Eine Implementierung kann einen Zeitstempel, eine Nonce oder einen anderen Wert an, die, den er wünscht, dass, von dieser Methode zurückgeben.</span><span class="sxs-lookup"><span data-stu-id="3c089-261">An implementer could return a timestamp, a nonce, or any other value she wishes from this method.</span></span>

<span data-ttu-id="3c089-262">Auf ähnliche Weise die *ValidateAdditionalData* Methode jedes Mal aufgerufen, wird ein Token überprüft, und die "zusätzliche Daten"-Zeichenfolge, die im Token eingebettet Waren an die Methode übergeben wird.</span><span class="sxs-lookup"><span data-stu-id="3c089-262">Similarly, the *ValidateAdditionalData* method is called each time a field token is validated, and the "additional data" string that was embedded within the token is passed to the method.</span></span> <span data-ttu-id="3c089-263">Die Validierungsroutine kann ein Timeout (durch überprüfen die aktuelle Zeit mit dem Zeitpunkt, der gespeichert wurde, wenn das Token erstellt wurde) implementiert, eine Nonce überprüfen, Routine oder einen anderen gewünschten Logik.</span><span class="sxs-lookup"><span data-stu-id="3c089-263">The validation routine could implement a timeout (by checking the current time against the time that was stored when the token was created), a nonce checking routine, or any other desired logic.</span></span>

## <a name="design-decisions-and-security-considerations"></a><span data-ttu-id="3c089-264">Entwurfsentscheidungen und Überlegungen zur Sicherheit</span><span class="sxs-lookup"><span data-stu-id="3c089-264">Design decisions and security considerations</span></span>

<span data-ttu-id="3c089-265">Das Sicherheitstoken, das die Sitzung und Feld-Token verknüpft ist technisch nur erforderlich, wenn Sie versuchen, anonyme / nicht authentifizierte Benutzer vor XSRF-Angriffen zu schützen.</span><span class="sxs-lookup"><span data-stu-id="3c089-265">The security token that links the session and field tokens is technically only necessary when trying to protect anonymous / unauthenticated users against XSRF attacks.</span></span> <span data-ttu-id="3c089-266">Wenn der Benutzer authentifiziert ist, kann das Authentifizierungstoken selbst der (vermutlich in Form eines Cookies übermittelt) verwendet werden, als eine Hälfte der eine für die domänensynchronisierung Tokenpaars.</span><span class="sxs-lookup"><span data-stu-id="3c089-266">When the user is authenticated, the authentication token itself (presumably submitted in the form of a cookie) could be used as one half of a synchronizer token pair.</span></span> <span data-ttu-id="3c089-267">Es sind allerdings gültige Szenarien für den Schutz von Anmeldeseiten, die von nicht authentifizierten Benutzern erreicht, und die Anti-XSRF-Logik durch immer generieren und überprüfen das Sicherheitstoken, sogar für authentifizierte Benutzer wurde vereinfacht.</span><span class="sxs-lookup"><span data-stu-id="3c089-267">However, there are valid scenarios for protecting login pages hit by unauthenticated users, and the anti-XSRF logic was made simpler by always generating and validating the security token, even for authenticated users.</span></span> <span data-ttu-id="3c089-268">Es stellt auch einige zusätzlichen Schutz bereit, die ein Token von einem Angreifer, festlegen oder zu erraten, dass das Sitzungstoken, das eine andere Hürde für Angreifer zu überwinden wäre je kompromittiert wurde.</span><span class="sxs-lookup"><span data-stu-id="3c089-268">It also does provide some additional protection in the event that a field token is ever compromised by an attacker, as setting or guessing the session token would be another hurdle for the attacker to overcome.</span></span>

<span data-ttu-id="3c089-269">Entwickler sollten Vorsicht verwenden, wenn mehrere Anwendungen in einer einzelnen Domäne gehostet werden.</span><span class="sxs-lookup"><span data-stu-id="3c089-269">Developers should use caution when multiple applications are hosted in a single domain.</span></span> <span data-ttu-id="3c089-270">Beispielsweise, obwohl *example1.cloudapp.net* und *example2.cloudapp.net* sind verschiedene Hosts besteht ein implizites Vertrauensverhältnis zwischen allen Hosts der  *\*. cloudapp.net* Domäne.</span><span class="sxs-lookup"><span data-stu-id="3c089-270">For example, even though *example1.cloudapp.net* and *example2.cloudapp.net* are different hosts, there is an implicit trust relationship between all hosts under the *\*.cloudapp.net* domain.</span></span> <span data-ttu-id="3c089-271">Diese implizite Vertrauensstellung [können potenziell nicht vertrauenswürdige Hosts beeinflussen die Cookies des anderen](http://stackoverflow.com/questions/9636857/how-can-asp-net-or-asp-net-mvc-be-protected-from-related-domain-cookie-attacks) (die gleichen Ursprungs-Richtlinien, die steuern, AJAX-Anforderungen unbedingt gelten nicht für HTTP-Cookies).</span><span class="sxs-lookup"><span data-stu-id="3c089-271">This implicit trust relationship [allows potentially untrusted hosts to affect each other's cookies](http://stackoverflow.com/questions/9636857/how-can-asp-net-or-asp-net-mvc-be-protected-from-related-domain-cookie-attacks) (the same-origin policies that govern AJAX requests do not necessarily apply to HTTP cookies).</span></span> <span data-ttu-id="3c089-272">Die ASP.NET Web-Stack-Laufzeit enthält Korrekturen, der Benutzernamen in das Feldtoken eingebettet ist, also auch wenn eine böswillige Unterdomäne einen Sitzungstoken überschreiben kann es kann nicht zum Generieren eines gültigen Felds Tokens für den Benutzer.</span><span class="sxs-lookup"><span data-stu-id="3c089-272">The ASP.NET Web Stack Runtime provides some mitigation in that the username is embedded into the field token, so even if a malicious subdomain is able to overwrite a session token it will be unable to generate a valid field token for the user.</span></span> <span data-ttu-id="3c089-273">Allerdings können nicht beim Hosten in einer solchen Umgebung die integrierte Anti-XSRF-Routinen weiterhin Sitzungsübernahmen oder XSRF-Anmeldung abzuwehren.</span><span class="sxs-lookup"><span data-stu-id="3c089-273">However, when hosted in such an environment the built-in anti-XSRF routines still cannot defend against session hijacking or login XSRF.</span></span>

<span data-ttu-id="3c089-274">Die Anti-XSRF-Routinen sind derzeit nicht für verteidigen [Clickjacking](https://www.owasp.org/index.php/Clickjacking).</span><span class="sxs-lookup"><span data-stu-id="3c089-274">The anti-XSRF routines currently do not defend against [clickjacking](https://www.owasp.org/index.php/Clickjacking).</span></span> <span data-ttu-id="3c089-275">Anwendungen, die sich selbst gegen Clickjacking verwendet werden soll können dies ganz einfach durch Senden eine X-Frame-Options: SAMEORIGIN-Header mit jeder Antwort.</span><span class="sxs-lookup"><span data-stu-id="3c089-275">Applications that wish to defend themselves against clickjacking may easily do so by sending an X-Frame-Options: SAMEORIGIN header with each response.</span></span> <span data-ttu-id="3c089-276">Dieser Header wird von allen aktuellen Browsern unterstützt.</span><span class="sxs-lookup"><span data-stu-id="3c089-276">This header is supported by all recent browsers.</span></span> <span data-ttu-id="3c089-277">Weitere Informationen finden Sie unter den [IE-Blog](https://blogs.msdn.com/b/ieinternals/archive/2010/03/30/combating-clickjacking-with-x-frame-options.aspx), [SDL-Blog](https://blogs.msdn.com/b/sdl/archive/2009/02/05/clickjacking-defense-in-ie8.aspx), und [OWASP](https://www.owasp.org/index.php/Clickjacking).</span><span class="sxs-lookup"><span data-stu-id="3c089-277">For more information, see the [IE blog](https://blogs.msdn.com/b/ieinternals/archive/2010/03/30/combating-clickjacking-with-x-frame-options.aspx), the [SDL blog](https://blogs.msdn.com/b/sdl/archive/2009/02/05/clickjacking-defense-in-ie8.aspx), and [OWASP](https://www.owasp.org/index.php/Clickjacking).</span></span> <span data-ttu-id="3c089-278">Die ASP.NET Web Stack Runtime kann in eine zukünftige Version stellen die MVC und Webseiten Anti-XSRF-Hilfsprogramme diesen Header automatisch festgelegt, damit Anwendungen gegen solche Angriffe automatisch geschützt sind.</span><span class="sxs-lookup"><span data-stu-id="3c089-278">The ASP.NET Web Stack Runtime may in some future release make the MVC and Web Pages anti-XSRF helpers automatically set this header so that applications are automatically protected against this attack.</span></span>

<span data-ttu-id="3c089-279">Webentwickler sollten weiterhin, um sicherzustellen, dass ihre Website nicht für XSS-Angriffe anfällig ist.</span><span class="sxs-lookup"><span data-stu-id="3c089-279">Web developers should continue to ensure that their site is not vulnerable to XSS attacks.</span></span> <span data-ttu-id="3c089-280">XSS-Angriffe sind sehr leistungsstark und ein erfolgreicher Exploit wird auch die ASP.NET Web Stack Runtime Schutzmaßnahmen vor XSRF-Angriffen unterbrochen.</span><span class="sxs-lookup"><span data-stu-id="3c089-280">XSS attacks are very powerful, and a successful exploit would also break the ASP.NET Web Stack Runtime defenses against XSRF attacks.</span></span>

## <a name="acknowledgment"></a><span data-ttu-id="3c089-281">Bestätigung</span><span class="sxs-lookup"><span data-stu-id="3c089-281">Acknowledgment</span></span>

<span data-ttu-id="3c089-282">[@LeviBroderick](https://twitter.com/LeviBroderick), ein Großteil der ASP-Sicherheit-Code den Großteil dieser Informationen geschrieben.</span><span class="sxs-lookup"><span data-stu-id="3c089-282">[@LeviBroderick](https://twitter.com/LeviBroderick), who wrote much of the ASP.NET security code the bulk of this information.</span></span>
