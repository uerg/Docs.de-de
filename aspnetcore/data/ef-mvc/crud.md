---
title: ASP.NET Core MVC mit EF Core − Erweitert (2 von 10)
author: rick-anderson
description: ''
manager: wpickett
ms.author: tdykstra
ms.date: 03/15/2017
ms.prod: asp.net-core
ms.technology: aspnet
ms.topic: get-started-article
uid: data/ef-mvc/crud
ms.openlocfilehash: ec3f048c97d4e950fa76250382e4e18ccbea29e1
ms.sourcegitcommit: a19261eb82b948af6e4a1664fcfb8dabb16150e3
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 05/14/2018
ms.locfileid: "34153585"
---
# <a name="aspnet-core-mvc-with-ef-core---crud---2-of-10"></a><span data-ttu-id="da29d-102">ASP.NET Core MVC mit EF Core − Erweitert (2 von 10)</span><span class="sxs-lookup"><span data-stu-id="da29d-102">ASP.NET Core MVC with EF Core - CRUD - 2 of 10</span></span>

<span data-ttu-id="da29d-103">Von [Tom Dykstra](https://github.com/tdykstra) und [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="da29d-103">By [Tom Dykstra](https://github.com/tdykstra) and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="da29d-104">Die Contoso University-Beispielwebanwendung veranschaulicht, wie ASP.NET Core MVC-Webanwendungen mit Entity Framework Core und Visual Studio erstellt werden.</span><span class="sxs-lookup"><span data-stu-id="da29d-104">The Contoso University sample web application demonstrates how to create ASP.NET Core MVC web applications using Entity Framework Core and Visual Studio.</span></span> <span data-ttu-id="da29d-105">Informationen zu dieser Tutorialreihe finden Sie im [ersten Tutorial der Reihe](intro.md).</span><span class="sxs-lookup"><span data-stu-id="da29d-105">For information about the tutorial series, see [the first tutorial in the series](intro.md).</span></span>

<span data-ttu-id="da29d-106">Im vorherigen Tutorial haben Sie eine MVC-Anwendung erstellt, die Entity Framework und SQL Server LocalDB verwendet, um Daten zu speichern und anzuzeigen.</span><span class="sxs-lookup"><span data-stu-id="da29d-106">In the previous tutorial, you created an MVC application that stores and displays data using the Entity Framework and SQL Server LocalDB.</span></span> <span data-ttu-id="da29d-107">In diesem Tutorial überprüfen und passen Sie CRUD-Code (Create, Read, Update, Delete) an, der durch den MVC-Gerüstbau automatisch für Ihre Controller und Ansichten erstellt wird.</span><span class="sxs-lookup"><span data-stu-id="da29d-107">In this tutorial, you'll review and customize the CRUD (create, read, update, delete) code that the MVC scaffolding automatically creates for you in controllers and views.</span></span>

> [!NOTE] 
> <span data-ttu-id="da29d-108">Es ist üblich, dass das Repositorymuster implementiert wird, um eine Abstraktionsebene zwischen Ihrem Controller und der Datenzugriffsebene zu erstellen.</span><span class="sxs-lookup"><span data-stu-id="da29d-108">It's a common practice to implement the repository pattern in order to create an abstraction layer between your controller and the data access layer.</span></span> <span data-ttu-id="da29d-109">In diesen Tutorials werden keine Repositorys verwendet, um die Verwendung des Entity Frameworks einfach und zielorientiert zu erklären.</span><span class="sxs-lookup"><span data-stu-id="da29d-109">To keep these tutorials simple and focused on teaching how to use the Entity Framework itself, they don't use repositories.</span></span> <span data-ttu-id="da29d-110">Weitere Informationen über Repositorys mit EF finden Sie im [letzten Tutorial dieser Reihe](advanced.md).</span><span class="sxs-lookup"><span data-stu-id="da29d-110">For information about repositories with EF, see [the last tutorial in this series](advanced.md).</span></span>

<span data-ttu-id="da29d-111">In diesem Tutorial arbeiten Sie mit den folgenden Webseiten:</span><span class="sxs-lookup"><span data-stu-id="da29d-111">In this tutorial, you'll work with the following web pages:</span></span>

![Seite „Studentendetails“](crud/_static/student-details.png)

![Seite „Student erstellen“](crud/_static/student-create.png)

![Seite „Student bearbeiten“](crud/_static/student-edit.png)

![Seite „Student löschen“](crud/_static/student-delete.png)

## <a name="customize-the-details-page"></a><span data-ttu-id="da29d-116">Anpassen der Seite „Details“</span><span class="sxs-lookup"><span data-stu-id="da29d-116">Customize the Details page</span></span>

<span data-ttu-id="da29d-117">Der eingerüstete Code der Indexseite „Students“ lässt die Eigenschaft `Enrollments` aus, da diese Eigenschaft eine Auflistung enthält.</span><span class="sxs-lookup"><span data-stu-id="da29d-117">The scaffolded code for the Students Index page left out the `Enrollments` property, because that property holds a collection.</span></span> <span data-ttu-id="da29d-118">In der Seite **Details** zeigen Sie die Inhalte der Sammlung in einer HTML-Tabelle an.</span><span class="sxs-lookup"><span data-stu-id="da29d-118">In the **Details** page, you'll display the contents of the collection in an HTML table.</span></span>

<span data-ttu-id="da29d-119">Die Aktionsmethode für die Ansicht „Details“ in der Datei *Controllers/StudentsController.cs* verwendet die Methode `SingleOrDefaultAsync`, um eine einzelne Entität `Student` abzurufen.</span><span class="sxs-lookup"><span data-stu-id="da29d-119">In *Controllers/StudentsController.cs*, the action method for the Details view uses the `SingleOrDefaultAsync` method to retrieve a single `Student` entity.</span></span> <span data-ttu-id="da29d-120">Fügen Sie Code hinzu, der die Methoden `Include`,</span><span class="sxs-lookup"><span data-stu-id="da29d-120">Add code that calls `Include`.</span></span> <span data-ttu-id="da29d-121">`ThenInclude` und `AsNoTracking` aufruft, wie im folgenden hervorgehobenen Code gezeigt wird.</span><span class="sxs-lookup"><span data-stu-id="da29d-121">`ThenInclude`,  and `AsNoTracking` methods, as shown in the following highlighted code.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Details&highlight=8-12)]

<span data-ttu-id="da29d-122">Aufgrund der Methoden `Include` und `ThenInclude` lädt der Kontext die Navigationseigenschaft `Student.Enrollments` und in jeder Registrierung die Navigationseigenschaft `Enrollment.Course`.</span><span class="sxs-lookup"><span data-stu-id="da29d-122">The `Include` and `ThenInclude` methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span>  <span data-ttu-id="da29d-123">Im Tutorial [Lesen verwandter Daten](read-related-data.md) erfahren Sie mehr über diese Methoden.</span><span class="sxs-lookup"><span data-stu-id="da29d-123">You'll learn more about these methods in the [read related data](read-related-data.md) tutorial.</span></span>

<span data-ttu-id="da29d-124">Die Methode `AsNoTracking` verbessert die Leistung in Szenarios, in denen zurückgegebene Entitäten nicht während dem aktuellen Kontext aktualisiert werden.</span><span class="sxs-lookup"><span data-stu-id="da29d-124">The `AsNoTracking` method improves performance in scenarios where the entities returned won't be updated in the current context's lifetime.</span></span> <span data-ttu-id="da29d-125">Am Ende dieses Tutorials erfahren Sie mehr über `AsNoTracking`.</span><span class="sxs-lookup"><span data-stu-id="da29d-125">You'll learn more about `AsNoTracking` at the end of this tutorial.</span></span>

### <a name="route-data"></a><span data-ttu-id="da29d-126">Routendaten</span><span class="sxs-lookup"><span data-stu-id="da29d-126">Route data</span></span>

<span data-ttu-id="da29d-127">Der Schlüsselwert, der an die Methode `Details` weitergegeben wird, stammt von den *Routendaten*.</span><span class="sxs-lookup"><span data-stu-id="da29d-127">The key value that's passed to the `Details` method comes from *route data*.</span></span> <span data-ttu-id="da29d-128">Routendaten sind Daten, die die Modellbindung in einem Segment der URL gefunden hat.</span><span class="sxs-lookup"><span data-stu-id="da29d-128">Route data is data that the model binder found in a segment of the URL.</span></span> <span data-ttu-id="da29d-129">Die Standardroute gibt zum Beispiel Controller, Aktion und ID-Segmente an:</span><span class="sxs-lookup"><span data-stu-id="da29d-129">For example, the default route specifies controller, action, and id segments:</span></span>

[!code-csharp[](intro/samples/cu/Startup.cs?name=snippet_Route&highlight=5)]

<span data-ttu-id="da29d-130">In der folgenden URL ordnet die Standardroute den Dozenten als den Controller, den Index als die Aktion und 1 als die ID ein. Dies sind Datenwerte für die Route.</span><span class="sxs-lookup"><span data-stu-id="da29d-130">In the following URL, the default route maps Instructor as the controller, Index as the action, and 1 as the id; these are route data values.</span></span>

```
http://localhost:1230/Instructor/Index/1?courseID=2021
```

<span data-ttu-id="da29d-131">Der letzte Teil der URL („?courseID=2021“) ist ein Abfragezeichenfolgenwert.</span><span class="sxs-lookup"><span data-stu-id="da29d-131">The last part of the URL ("?courseID=2021") is a query string value.</span></span> <span data-ttu-id="da29d-132">Die Modellbindung gibt auch den ID-Wert an den Parameter `id` der Methode `Details` weiter, wenn Sie ihn als Abfragezeichenfolgenwert übergeben:</span><span class="sxs-lookup"><span data-stu-id="da29d-132">The model binder will also pass the ID value to the `Details` method `id` parameter if you pass it as a query string value:</span></span>

```
http://localhost:1230/Instructor/Index?id=1&CourseID=2021
```

<span data-ttu-id="da29d-133">In der Indexseite werden Link-URLs von Anweisungen eines Taghilfsprogramms in der Razor-Ansicht erstellt.</span><span class="sxs-lookup"><span data-stu-id="da29d-133">In the Index page, hyperlink URLs are created by tag helper statements in the Razor view.</span></span> <span data-ttu-id="da29d-134">Im folgenden Razor-Code entspricht der Parameter `id` der Standardroute, daher wird `id` den Routendaten hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="da29d-134">In the following Razor code, the `id` parameter matches the default route, so `id` is added to the route data.</span></span>

```html
<a asp-action="Edit" asp-route-id="@item.ID">Edit</a>
```

<span data-ttu-id="da29d-135">Wenn `item.ID` 6 entspricht, generiert dies den folgenden HTML-Code:</span><span class="sxs-lookup"><span data-stu-id="da29d-135">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit/6">Edit</a>
```

<span data-ttu-id="da29d-136">Im folgenden Razor-Code entspricht `studentID` nicht einem Parameter der Standardroute, daher wird sie als Abfragezeichenfolge hinzugefügt.</span><span class="sxs-lookup"><span data-stu-id="da29d-136">In the following Razor code, `studentID` doesn't match a parameter in the default route, so it's added as a query string.</span></span>

```html
<a asp-action="Edit" asp-route-studentID="@item.ID">Edit</a>
```

<span data-ttu-id="da29d-137">Wenn `item.ID` 6 entspricht, generiert dies den folgenden HTML-Code:</span><span class="sxs-lookup"><span data-stu-id="da29d-137">This generates the following HTML when `item.ID` is 6:</span></span>

```html
<a href="/Students/Edit?studentID=6">Edit</a>
```

<span data-ttu-id="da29d-138">Weitere Informationen zu Taghilfsprogrammen finden Sie unter [Taghilfsprogramme in ASP.NET Core](xref:mvc/views/tag-helpers/intro).</span><span class="sxs-lookup"><span data-stu-id="da29d-138">For more information about tag helpers, see [Tag helpers in ASP.NET Core](xref:mvc/views/tag-helpers/intro).</span></span>

### <a name="add-enrollments-to-the-details-view"></a><span data-ttu-id="da29d-139">Hinzufügen von Registrierungen in die Detailansicht</span><span class="sxs-lookup"><span data-stu-id="da29d-139">Add enrollments to the Details view</span></span>

<span data-ttu-id="da29d-140">Öffnen Sie *Views/Students/Details.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="da29d-140">Open *Views/Students/Details.cshtml*.</span></span> <span data-ttu-id="da29d-141">Alle Felder werden mithilfe der Hilfsprogramme `DisplayNameFor` und `DisplayFor` dargestellt, wie in folgendem Beispiel gezeigt wird:</span><span class="sxs-lookup"><span data-stu-id="da29d-141">Each field is displayed using `DisplayNameFor` and `DisplayFor` helpers, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=13-18&highlight=2,5)]

<span data-ttu-id="da29d-142">Fügen Sie den folgenden Code nach dem letzten Feld und direkt vor dem Endtag `</dl>` ein, um eine Liste der Registrierungen anzuzeigen:</span><span class="sxs-lookup"><span data-stu-id="da29d-142">After the last field and immediately before the closing `</dl>` tag, add the following code to display a list of enrollments:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Details.cshtml?range=31-52)]

<span data-ttu-id="da29d-143">Wenn der Codeeinzug nach dem Einfügen des Codes falsch ist, drücken Sie Strg + K + D, um diesen zu korrigieren.</span><span class="sxs-lookup"><span data-stu-id="da29d-143">If code indentation is wrong after you paste the code, press CTRL-K-D to correct it.</span></span>

<span data-ttu-id="da29d-144">Dieser Code durchläuft die Entitäten in der Navigationseigenschaft `Enrollments`.</span><span class="sxs-lookup"><span data-stu-id="da29d-144">This code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="da29d-145">Für jede Registrierung werden der Kurstitel und die Klasse angezeigt.</span><span class="sxs-lookup"><span data-stu-id="da29d-145">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="da29d-146">Der Kurstitel wird von der Entität „Course“ abgerufen, die in der Navigationseigenschaft `Course` der Entität „Enrollments“ gespeichert ist.</span><span class="sxs-lookup"><span data-stu-id="da29d-146">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="da29d-147">Führen Sie die App aus, wählen Sie die Registerkarte **Studenten** aus, und klicken Sie bei einem Studenten auf den Link **Details**.</span><span class="sxs-lookup"><span data-stu-id="da29d-147">Run the app, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="da29d-148">Die Liste der Kurse und Klassen für den ausgewählten Studenten wird angezeigt:</span><span class="sxs-lookup"><span data-stu-id="da29d-148">You see the list of courses and grades for the selected student:</span></span>

![Seite „Studentendetails“](crud/_static/student-details.png)

## <a name="update-the-create-page"></a><span data-ttu-id="da29d-150">Aktualisieren der Seite „Create“ (Erstellen)</span><span class="sxs-lookup"><span data-stu-id="da29d-150">Update the Create page</span></span>

<span data-ttu-id="da29d-151">Bearbeiten Sie die HttpPost-Methode `Create` in *StudentsController.cs*, indem Sie einen Try-Catch-Block hinzufügen und die ID aus dem Attribut `Bind` entfernen.</span><span class="sxs-lookup"><span data-stu-id="da29d-151">In *StudentsController.cs*, modify the HttpPost `Create` method by adding a try-catch block and removing ID from the `Bind` attribute.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=4,6-7,14-21)]

<span data-ttu-id="da29d-152">Dieser Code fügt die Entität „Student“ (Schüler) der Entitätenmenge „Students“ hinzu, die durch die ASP.NET MVC-Modellbindung erstellt wurde, und speichert die Änderungen in der Datenbank.</span><span class="sxs-lookup"><span data-stu-id="da29d-152">This code adds the Student entity created by the ASP.NET MVC model binder to the Students entity set and then saves the changes to the database.</span></span> <span data-ttu-id="da29d-153">(Die Modellbindung ist eine Funktionalität von ASP.NET MVC, die Ihnen die Arbeit mit Daten vereinfacht, die über ein Formular übermittelt wurden. Eine Modellbindung konvertiert übermittelte Formularwerte in CLR-Typen und übergibt diese als Parameter an die Aktionsmethode.</span><span class="sxs-lookup"><span data-stu-id="da29d-153">(Model binder refers to the ASP.NET MVC functionality that makes it easier for you to work with data submitted by a form; a model binder converts posted form values to CLR types and passes them to the action method in parameters.</span></span> <span data-ttu-id="da29d-154">In diesem Fall instanziiert die Modellbindung für Sie eine Entität „Student“, mithilfe von Eigenschaftswerten aus der Formularauflistung.)</span><span class="sxs-lookup"><span data-stu-id="da29d-154">In this case, the model binder instantiates a Student entity for you using property values from the Form collection.)</span></span>

<span data-ttu-id="da29d-155">Sie haben `ID` aus dem Attribut `Bind` entfernt, da ID der primäre Schlüsselwert ist, den SQL Server automatisch festlegt, wenn die Zeile eingefügt wird.</span><span class="sxs-lookup"><span data-stu-id="da29d-155">You removed `ID` from the `Bind` attribute because ID is the primary key value which SQL Server will set automatically when the row is inserted.</span></span> <span data-ttu-id="da29d-156">Der ID-Wert wird nicht über Eingabe vom Benutzer festgelegt.</span><span class="sxs-lookup"><span data-stu-id="da29d-156">Input from the user doesn't set the ID value.</span></span>

<span data-ttu-id="da29d-157">Abgesehen vom Attribut `Bind`, ist der Try-Catch-Block die einzige Änderung, die Sie am eingerüsteten Code vorgenommen haben.</span><span class="sxs-lookup"><span data-stu-id="da29d-157">Other than the `Bind` attribute, the try-catch block is the only change you've made to the scaffolded code.</span></span> <span data-ttu-id="da29d-158">Wenn eine Ausnahme abgefangen wird, die von `DbUpdateException` abgeleitet wird, während die Änderungen gespeichert werden, wird eine generische Fehlermeldung angezeigt.</span><span class="sxs-lookup"><span data-stu-id="da29d-158">If an exception that derives from `DbUpdateException` is caught while the changes are being saved, a generic error message is displayed.</span></span> <span data-ttu-id="da29d-159">`DbUpdateException`-Ausnahmen werden manchmal durch etwas außerhalb der Anwendung ausgelöst, und nicht durch einen Programmierfehler. Es wird empfohlen, dass der Benutzer es erneut versucht.</span><span class="sxs-lookup"><span data-stu-id="da29d-159">`DbUpdateException` exceptions are sometimes caused by something external to the application rather than a programming error, so the user is advised to try again.</span></span> <span data-ttu-id="da29d-160">Zwar wird es in diesem Beispiel nicht implementiert, aber eine qualitätsorientierte Produktionsanwendung würde die Ausnahme protokollieren.</span><span class="sxs-lookup"><span data-stu-id="da29d-160">Although not implemented in this sample, a production quality application would log the exception.</span></span> <span data-ttu-id="da29d-161">Weitere Informationen finden Sie im Abschnitt **Log for insight (Einblicke durch Protokollierung)** im Artikel [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure) (Überwachung und Telemetrie (Erstellen von realitätsnahen Cloud-Apps mit Azure))](https://docs.microsoft.com/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span><span class="sxs-lookup"><span data-stu-id="da29d-161">For more information, see the **Log for insight** section in [Monitoring and Telemetry (Building Real-World Cloud Apps with Azure)](https://docs.microsoft.com/aspnet/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/monitoring-and-telemetry).</span></span>

<span data-ttu-id="da29d-162">Das Attribut `ValidateAntiForgeryToken` hilft dabei, Angriffe mit der Websiteübergreifenden Anforderungsfälschung (CSRF) zu verhindern.</span><span class="sxs-lookup"><span data-stu-id="da29d-162">The `ValidateAntiForgeryToken` attribute helps prevent cross-site request forgery (CSRF) attacks.</span></span> <span data-ttu-id="da29d-163">Der [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) injiziert das Token automatisch in die Ansicht und ist enthalten, wenn das Formular vom Benutzer gesendet wird.</span><span class="sxs-lookup"><span data-stu-id="da29d-163">The token is automatically injected into the view by the [FormTagHelper](xref:mvc/views/working-with-forms#the-form-tag-helper) and is included when the form is submitted by the user.</span></span> <span data-ttu-id="da29d-164">Das Token wird vom Attribut `ValidateAntiForgeryToken` überprüft.</span><span class="sxs-lookup"><span data-stu-id="da29d-164">The token is validated by the `ValidateAntiForgeryToken` attribute.</span></span> <span data-ttu-id="da29d-165">Weitere Informationen über CSRF finden Sie unter [Anti-Request Forgery (Antianforderungsfälschung)](../../security/anti-request-forgery.md).</span><span class="sxs-lookup"><span data-stu-id="da29d-165">For more information about CSRF, see [Anti-Request Forgery](../../security/anti-request-forgery.md).</span></span>

<a id="overpost"></a>
### <a name="security-note-about-overposting"></a><span data-ttu-id="da29d-166">Sicherheitshinweis zum Overposting</span><span class="sxs-lookup"><span data-stu-id="da29d-166">Security note about overposting</span></span>

<span data-ttu-id="da29d-167">Das Attribut `Bind`, das der eingerüstete Code in der Methode `Create` enthält, ist eine Möglichkeit zum Schutz vor Overposting in Erstellungsszenarios.</span><span class="sxs-lookup"><span data-stu-id="da29d-167">The `Bind` attribute that the scaffolded code includes on the `Create` method is one way to protect against overposting in create scenarios.</span></span> <span data-ttu-id="da29d-168">Nehmen wir beispielsweise an, die Entität „Student“ enthält die Eigenschaft `Secret`, die von dieser Webseite nicht festgelegt werden soll.</span><span class="sxs-lookup"><span data-stu-id="da29d-168">For example, suppose the Student entity includes a `Secret` property that you don't want this web page to set.</span></span>

```csharp
public class Student
{
    public int ID { get; set; }
    public string LastName { get; set; }
    public string FirstMidName { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public string Secret { get; set; }
}
```

<span data-ttu-id="da29d-169">Selbst wenn Sie kein `Secret`-Feld auf dieser Webseite haben, könnte ein Hacker ein Tool wie „Fiddler“ verwenden oder JavaScript-Code schreiben, um einen `Secret`-Formularwert bereitzustellen.</span><span class="sxs-lookup"><span data-stu-id="da29d-169">Even if you don't have a `Secret` field on the web page, a hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="da29d-170">Wenn das Attribut `Bind` nicht die Felder beschränkt, die die Modellbindung verwendet, wenn sie eine Studentinstanz erstellt, würde die Modellbindung den Formularwert `Secret` abrufen, und zum Erstellen der Entitätsinstanz „Student“ verwenden.</span><span class="sxs-lookup"><span data-stu-id="da29d-170">Without the `Bind` attribute limiting the fields that the model binder uses when it creates a Student instance, the model binder would pick up that `Secret` form value and use it to create the Student entity instance.</span></span> <span data-ttu-id="da29d-171">Dann würde jeder beliebige Wert in Ihre Datenbank aktualisiert werden, den der Hacker für das Formularfeld `Secret` festlegt.</span><span class="sxs-lookup"><span data-stu-id="da29d-171">Then whatever value the hacker specified for the `Secret` form field would be updated in your database.</span></span> <span data-ttu-id="da29d-172">Die folgende Abbildung zeigt das Fiddler-Tool beim Hinzufügen des Felds `Secret` (mit dem Wert „OverPost“) zu den bereitgestellten Formularwerten.</span><span class="sxs-lookup"><span data-stu-id="da29d-172">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![Fiddler beim Hinzufügen des Felds „Secret“](crud/_static/fiddler.png)

<span data-ttu-id="da29d-174">Der Wert „OverPost“ würde dann erfolgreich der Eigenschaft `Secret` der eingefügten Zeile hinzugefügt werden, obwohl Sie nie beabsichtigt haben, dass die Webseite diese Eigenschaft festlegen kann.</span><span class="sxs-lookup"><span data-stu-id="da29d-174">The value "OverPost" would then be successfully added to the `Secret` property of the inserted row, although you never intended that the web page be able to set that property.</span></span>

<span data-ttu-id="da29d-175">Sie können das Overposting in Bearbeitungsszenarios verhindern, indem Sie die Entität zuerst aus der Datenbank lesen und dann `TryUpdateModel` aufrufen, und eine explizit erlaubte Eigenschaftenliste übergeben.</span><span class="sxs-lookup"><span data-stu-id="da29d-175">You can prevent overposting in edit scenarios by reading the entity from the database first and then calling `TryUpdateModel`, passing in an explicit allowed properties list.</span></span> <span data-ttu-id="da29d-176">Dies ist die Methode, die in diesen Tutorials verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="da29d-176">That's the method used in these tutorials.</span></span>

<span data-ttu-id="da29d-177">Eine alternative Möglichkeit zum vermeiden von Overposting, die von vielen Entwicklern bevorzugt wird, ist das Verwenden von Ansichtsmodellen, anstelle von Entitätsklassen mit Modellbindung.</span><span class="sxs-lookup"><span data-stu-id="da29d-177">An alternative way to prevent overposting that's preferred by many developers is to use view models rather than entity classes with model binding.</span></span> <span data-ttu-id="da29d-178">Schließen Sie nur die Eigenschaften in dem Ansichtsmodell ein, die Sie aktualisieren möchten.</span><span class="sxs-lookup"><span data-stu-id="da29d-178">Include only the properties you want to update in the view model.</span></span> <span data-ttu-id="da29d-179">Sobald die MVC-Modellbindung abgeschlossen ist, kopieren Sie die Ansichtsmodelleigenschaften in die Entitätsinstanz, optional unter Verwendung eines Tools wie AutoMapper.</span><span class="sxs-lookup"><span data-stu-id="da29d-179">Once the MVC model binder has finished, copy the view model properties to the entity instance, optionally using a tool such as AutoMapper.</span></span> <span data-ttu-id="da29d-180">Wenden Sie `_context.Entry` auf die Entitätsinstanz an, um ihren Status auf `Unchanged` festzulegen, und legen Sie dann `Property("PropertyName").IsModified` in jeder Entitätseigenschaft, die im Ansichtsmodell enthalten ist, auf TRUE fest.</span><span class="sxs-lookup"><span data-stu-id="da29d-180">Use `_context.Entry` on the entity instance to set its state to `Unchanged`, and then set `Property("PropertyName").IsModified` to true on each entity property that's included in the view model.</span></span> <span data-ttu-id="da29d-181">Diese Methode funktioniert sowohl im Bearbeitungsszenario als auch im Erstellungsszenario.</span><span class="sxs-lookup"><span data-stu-id="da29d-181">This method works in both edit and create scenarios.</span></span>

### <a name="test-the-create-page"></a><span data-ttu-id="da29d-182">Testen der Seite „Create“ (Erstellen)</span><span class="sxs-lookup"><span data-stu-id="da29d-182">Test the Create page</span></span>

<span data-ttu-id="da29d-183">Der Code in der Datei *Views/Students/Create.cshtml* verwendet die Taghilfsprogramme `label`, `input` und `span` (für Validierungsmeldungen) für jedes Feld.</span><span class="sxs-lookup"><span data-stu-id="da29d-183">The code in *Views/Students/Create.cshtml* uses `label`, `input`, and `span` (for validation messages) tag helpers for each field.</span></span>

<span data-ttu-id="da29d-184">Führen Sie die Anwendung aus, wählen Sie die Registerkarte **Students** aus und klicken auf **Neu erstellen**.</span><span class="sxs-lookup"><span data-stu-id="da29d-184">Run the app, select the **Students** tab, and click **Create New**.</span></span>

<span data-ttu-id="da29d-185">Geben Sie Namen und ein Datum ein.</span><span class="sxs-lookup"><span data-stu-id="da29d-185">Enter names and a date.</span></span> <span data-ttu-id="da29d-186">Versuchen Sie ein ungültiges Datum einzugeben, sofern Ihr Browser dies zulässt.</span><span class="sxs-lookup"><span data-stu-id="da29d-186">Try entering an invalid date if your browser lets you do that.</span></span> <span data-ttu-id="da29d-187">(Manche Browser erzwingen die Verwendung einer Datumsauswahl.) Klicken Sie dann auf **Erstellen**, um die Fehlermeldung anzuzeigen.</span><span class="sxs-lookup"><span data-stu-id="da29d-187">(Some browsers force you to use a date picker.) Then click **Create** to see the error message.</span></span>

![Validierungsfehler beim Datum](crud/_static/date-error.png)

<span data-ttu-id="da29d-189">Dies ist eine serverseitige Validierung, die Sie standardgemäß erhalten. In einem späteren Tutorial sehen Sie, wie Sie Attribute hinzufügen, die auch Code für die clientseitige Validierung generieren.</span><span class="sxs-lookup"><span data-stu-id="da29d-189">This is server-side validation that you get by default; in a later tutorial you'll see how to add attributes that will generate code for client-side validation also.</span></span> <span data-ttu-id="da29d-190">Der folgende hervorgehobene Code zeigt die Überprüfung durch die Modellvalidierung in der Methode `Create`.</span><span class="sxs-lookup"><span data-stu-id="da29d-190">The following highlighted code shows the model validation check in the `Create` method.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_Create&highlight=8)]

<span data-ttu-id="da29d-191">Ändern Sie das Datum in einen gültigen Wert und klicken auf **Erstellen**, damit der neue Student auf der Seite **Index** angezeigt wird.</span><span class="sxs-lookup"><span data-stu-id="da29d-191">Change the date to a valid value and click **Create** to see the new student appear in the **Index** page.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="da29d-192">Aktualisieren der Seite „Edit“ (Bearbeiten)</span><span class="sxs-lookup"><span data-stu-id="da29d-192">Update the Edit page</span></span>

<span data-ttu-id="da29d-193">Die HttpGet-Methode `Edit` (ohne das Attribut `HttpPost`) in der Datei *StudentController.cs* verwendet die Methode `SingleOrDefaultAsync`, um die ausgewählte Studententität abzurufen, wie Sie bereits in der Methode `Details` gesehen haben.</span><span class="sxs-lookup"><span data-stu-id="da29d-193">In *StudentController.cs*, the HttpGet `Edit` method (the one without the `HttpPost` attribute) uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the `Details` method.</span></span> <span data-ttu-id="da29d-194">Sie müssen diese Methode nicht ändern.</span><span class="sxs-lookup"><span data-stu-id="da29d-194">You don't need to change this method.</span></span>

### <a name="recommended-httppost-edit-code-read-and-update"></a><span data-ttu-id="da29d-195">Empfohlener HttpPost-Edit-Code: Lesen und Aktualisieren</span><span class="sxs-lookup"><span data-stu-id="da29d-195">Recommended HttpPost Edit code: Read and update</span></span>

<span data-ttu-id="da29d-196">Ersetzen Sie die HttpPost-Edit-Aktionsmethode durch folgenden Code:</span><span class="sxs-lookup"><span data-stu-id="da29d-196">Replace the HttpPost Edit action method with the following code.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_ReadFirst)]

<span data-ttu-id="da29d-197">Diese Änderungen implementieren eine bewährte Sicherheitsmethode, um Overposting zu verhindern.</span><span class="sxs-lookup"><span data-stu-id="da29d-197">These changes implement a security best practice to prevent overposting.</span></span> <span data-ttu-id="da29d-198">Der Gerüstbauer hat ein `Bind`-Attribut generiert und die Entität hinzugefügt, die von der Modellbindung für die Entitätenmenge mit einem `Modified`-Flag erstellt wurde.</span><span class="sxs-lookup"><span data-stu-id="da29d-198">The scaffolder generated a `Bind` attribute and added the entity created by the model binder to the entity set with a `Modified` flag.</span></span> <span data-ttu-id="da29d-199">Dieser Code ist für viele Szenarios nicht empfohlen, weil das Attribut `Bind` vorhandene Daten aus Feldern löscht, die nicht im Parameter `Include` aufgelistet sind.</span><span class="sxs-lookup"><span data-stu-id="da29d-199">That code isn't recommended for many scenarios because the `Bind` attribute clears out any pre-existing data in fields not listed in the `Include` parameter.</span></span>

<span data-ttu-id="da29d-200">Der neue Code liest die vorhandene Entität und ruft `TryUpdateModel` auf, um Felder in der abgerufenen Entität [basierend auf Benutzereingaben in den gesendeten Formulardaten](xref:mvc/models/model-binding#how-model-binding-works) zu aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="da29d-200">The new code reads the existing entity and calls `TryUpdateModel` to update fields in the retrieved entity [based on user input in the posted form data](xref:mvc/models/model-binding#how-model-binding-works).</span></span> <span data-ttu-id="da29d-201">Die automatische Änderungsnachverfolgung des Entity Frameworks legt das Flag `Modified` auf den Feldern fest, die durch die Formulareingabe geändert wurden.</span><span class="sxs-lookup"><span data-stu-id="da29d-201">The Entity Framework's automatic change tracking sets the `Modified` flag on the fields that are changed by form input.</span></span> <span data-ttu-id="da29d-202">Wenn die Methode `SaveChanges` aufgerufen wird, erstellt Entity Framework SQL-Anweisungen, um die Datenbankzeile zu aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="da29d-202">When the `SaveChanges` method is called, the Entity Framework creates SQL statements to update the database row.</span></span> <span data-ttu-id="da29d-203">Nebenläufigkeitskonflikte werden ignoriert, und nur die Tabellenspalten, die vom Benutzer aktualisiert wurden, werden in der Datenbank aktualisiert.</span><span class="sxs-lookup"><span data-stu-id="da29d-203">Concurrency conflicts are ignored, and only the table columns that were updated by the user are updated in the database.</span></span> <span data-ttu-id="da29d-204">(In einem späteren Tutorial lernen Sie, wie man Nebenläufigkeitskonflikte behandelt.)</span><span class="sxs-lookup"><span data-stu-id="da29d-204">(A later tutorial shows how to handle concurrency conflicts.)</span></span>

<span data-ttu-id="da29d-205">Als eine bewährte Methode zum Verhindern von Overposting, sind die Felder in den `TryUpdateModel`-Parametern zugelassen, die durch die Seite **Edit** (Bearbeiten) aktualisierbar sein sollen.</span><span class="sxs-lookup"><span data-stu-id="da29d-205">As a best practice to prevent overposting, the fields that you want to be updateable by the **Edit** page are whitelisted in the `TryUpdateModel` parameters.</span></span> <span data-ttu-id="da29d-206">(Die leere Zeichenfolge vor der Liste der Felder in der Parameterliste ist für einen Präfix zur Verwendung mit den Namen der Formularfelder.) Derzeit sind keine zusätzlichen von Ihnen geschützten Felder vorhanden. Wenn Sie jedoch die Felder auflisten, die die Modellbindung binden soll, stellen Sie sicher, dass zukünftig hinzugefügte Felder automatisch geschützt sind, bis Sie sie explizit hier hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="da29d-206">(The empty string preceding the list of fields in the parameter list is for a prefix to use with the form fields names.) Currently there are no extra fields that you're protecting, but listing the fields that you want the model binder to bind ensures that if you add fields to the data model in the future, they're automatically protected until you explicitly add them here.</span></span>

<span data-ttu-id="da29d-207">Aus diesen Änderungen resultiert, dass die Methodensignatur der HttpPost-Methode `Edit` identisch mit der HttpGet-Methode `Edit` ist. Daher haben Sie die Methode in `EditPost` umbenannt.</span><span class="sxs-lookup"><span data-stu-id="da29d-207">As a result of these changes, the method signature of the HttpPost `Edit` method is the same as the HttpGet `Edit` method; therefore you've renamed the method `EditPost`.</span></span>

### <a name="alternative-httppost-edit-code-create-and-attach"></a><span data-ttu-id="da29d-208">Alternativer HttpPost-Edit-Code: Erstellen und Anfügen</span><span class="sxs-lookup"><span data-stu-id="da29d-208">Alternative HttpPost Edit code: Create and attach</span></span>

<span data-ttu-id="da29d-209">Der empfohlene HttpPost-Edit-Code stellt sicher, dass nur geänderte Spalten aktualisiert werden und behält Daten in Eigenschaften, die Sie nicht in der Modellbindung einschließen wollen.</span><span class="sxs-lookup"><span data-stu-id="da29d-209">The recommended HttpPost edit code ensures that only changed columns get updated and preserves data in properties that you don't want included for model binding.</span></span> <span data-ttu-id="da29d-210">Dieser Read-First-Ansatz benötigt jedoch einen zusätzlichen Datenbank-Lesevorgang und kann zu komplexeren Code für die Behandlung von Nebenläufigkeitskonflikten führen.</span><span class="sxs-lookup"><span data-stu-id="da29d-210">However, the read-first approach requires an extra database read, and can result in more complex code for handling concurrency conflicts.</span></span> <span data-ttu-id="da29d-211">Alternativ können Sie dem EF-Kontext eine Entität anfügen, die von der Modellbindung erstellt wurde, und diese als geändert markieren.</span><span class="sxs-lookup"><span data-stu-id="da29d-211">An alternative is to attach an entity created by the model binder to the EF context and mark it as modified.</span></span> <span data-ttu-id="da29d-212">(Aktualisieren Sie ihr Projekt nicht mit diesem Code, er wird hier nur gezeigt, um eine optionale Vorgehensweise zu veranschaulichen.)</span><span class="sxs-lookup"><span data-stu-id="da29d-212">(Don't update your project with this code, it's only shown to illustrate an optional approach.)</span></span> 

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_CreateAndAttach)]

<span data-ttu-id="da29d-213">Sie können diesen Ansatz verwenden, wenn die Benutzeroberfläche der Webseite alle Felder in der Entität enthält und diese aktualisieren kann.</span><span class="sxs-lookup"><span data-stu-id="da29d-213">You can use this approach when the web page UI includes all of the fields in the entity and can update any of them.</span></span>

<span data-ttu-id="da29d-214">Der eingerüstete Code verwendet einen Create-and-Attach-Ansatz (erstellen und anfügen), fängt aber nur `DbUpdateConcurrencyException`-Ausnahmen ab und gibt 404-Fehlermeldungen zurück.</span><span class="sxs-lookup"><span data-stu-id="da29d-214">The scaffolded code uses the create-and-attach approach but only catches `DbUpdateConcurrencyException` exceptions and returns 404 error codes.</span></span>  <span data-ttu-id="da29d-215">Das gezeigte Beispiel fängt jegliche Ausnahmen zu Updates der Datenbank ab und zeigt eine Fehlermeldung an.</span><span class="sxs-lookup"><span data-stu-id="da29d-215">The example shown catches any database update exception and displays an error message.</span></span>

### <a name="entity-states"></a><span data-ttu-id="da29d-216">Entitätsstatus</span><span class="sxs-lookup"><span data-stu-id="da29d-216">Entity States</span></span>

<span data-ttu-id="da29d-217">Der Datenbankkontext verfolgt, ob die Entitäten im Arbeitsspeicher mit ihren entsprechenden Zeilen in der Datenbank synchronisiert sind. Diese Information bestimmt, was passiert, wenn Sie die Methode `SaveChanges` aufrufen.</span><span class="sxs-lookup"><span data-stu-id="da29d-217">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database, and this information determines what happens when you call the `SaveChanges` method.</span></span> <span data-ttu-id="da29d-218">Wenn Sie beispielsweise eine neue Entität an die Methode `Add` übergeben, wird der Status dieser Entität auf `Added` festgelegt.</span><span class="sxs-lookup"><span data-stu-id="da29d-218">For example, when you pass a new entity to the `Add` method, that entity's state is set to `Added`.</span></span> <span data-ttu-id="da29d-219">Wenn Sie dann die Methode `SaveChanges` aufrufen, erteilt der Datenbankkontext einen SQL-Befehl INSERT.</span><span class="sxs-lookup"><span data-stu-id="da29d-219">Then when you call the `SaveChanges` method, the database context issues a SQL INSERT command.</span></span>

<span data-ttu-id="da29d-220">Eine Entität kann einen der folgenden Status aufweisen:</span><span class="sxs-lookup"><span data-stu-id="da29d-220">An entity may be in one of the following states:</span></span>

* <span data-ttu-id="da29d-221">`Added`</span><span class="sxs-lookup"><span data-stu-id="da29d-221">`Added`.</span></span> <span data-ttu-id="da29d-222">Die Entität ist noch nicht in der Datenbank vorhanden.</span><span class="sxs-lookup"><span data-stu-id="da29d-222">The entity doesn't yet exist in the database.</span></span> <span data-ttu-id="da29d-223">Die Methode `SaveChanges` gibt eine INSERT-Anweisung aus.</span><span class="sxs-lookup"><span data-stu-id="da29d-223">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="da29d-224">`Unchanged`</span><span class="sxs-lookup"><span data-stu-id="da29d-224">`Unchanged`.</span></span> <span data-ttu-id="da29d-225">Die Methode `SaveChanges` muss nichts mit dieser Entität tun.</span><span class="sxs-lookup"><span data-stu-id="da29d-225">Nothing needs to be done with this entity by the `SaveChanges` method.</span></span> <span data-ttu-id="da29d-226">Wenn Sie eine Entität aus der Datenbank lesen, beginnt die Entität mit diesem Status.</span><span class="sxs-lookup"><span data-stu-id="da29d-226">When you read an entity from the database, the entity starts out with this status.</span></span>

* <span data-ttu-id="da29d-227">`Modified`</span><span class="sxs-lookup"><span data-stu-id="da29d-227">`Modified`.</span></span> <span data-ttu-id="da29d-228">Einige oder alle Eigenschaftswerte der Entität wurden geändert.</span><span class="sxs-lookup"><span data-stu-id="da29d-228">Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="da29d-229">Die Methode `SaveChanges` gibt eine UPDATE-Anweisung aus.</span><span class="sxs-lookup"><span data-stu-id="da29d-229">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="da29d-230">`Deleted`</span><span class="sxs-lookup"><span data-stu-id="da29d-230">`Deleted`.</span></span> <span data-ttu-id="da29d-231">Die Entität wurde zum Löschen markiert.</span><span class="sxs-lookup"><span data-stu-id="da29d-231">The entity has been marked for deletion.</span></span> <span data-ttu-id="da29d-232">Die Methode `SaveChanges` gibt eine DELETE-Anweisung aus.</span><span class="sxs-lookup"><span data-stu-id="da29d-232">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="da29d-233">`Detached`</span><span class="sxs-lookup"><span data-stu-id="da29d-233">`Detached`.</span></span> <span data-ttu-id="da29d-234">Die Entität wird nicht vom Datenbankkontext nachverfolgt.</span><span class="sxs-lookup"><span data-stu-id="da29d-234">The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="da29d-235">Statusänderungen werden in einer Desktop-App in der Regel automatisch festgelegt.</span><span class="sxs-lookup"><span data-stu-id="da29d-235">In a desktop application, state changes are typically set automatically.</span></span> <span data-ttu-id="da29d-236">Sie lesen eine Entität aus und nehmen Änderungen an ihren Eigenschaftswerten vor.</span><span class="sxs-lookup"><span data-stu-id="da29d-236">You read an entity and make changes to some of its property values.</span></span> <span data-ttu-id="da29d-237">Dadurch wird der Entitätsstatus automatisch auf `Modified` festgelegt.</span><span class="sxs-lookup"><span data-stu-id="da29d-237">This causes its entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="da29d-238">Wenn Sie dann `SaveChanges` aufrufen, generiert Entity Framework eine SQL UPDATE-Anweisung, die nur die aktuellen Eigenschaften aktualisiert, an denen Sie Änderungen vorgenommen haben.</span><span class="sxs-lookup"><span data-stu-id="da29d-238">Then when you call `SaveChanges`, the Entity Framework generates a SQL UPDATE statement that updates only the actual properties that you changed.</span></span>

<span data-ttu-id="da29d-239">In einer Web-App wird der `DbContext`, der zunächst eine Entität liest und seine zu bearbeitenden Daten anzeigt, verworfen, nachdem eine Seite gerendert wurde.</span><span class="sxs-lookup"><span data-stu-id="da29d-239">In a web app, the `DbContext` that initially reads an entity and displays its data to be edited is disposed after a page is rendered.</span></span> <span data-ttu-id="da29d-240">Wenn die HttpPost-Aktionsmethode `Edit` einer Seite aufgerufen wird, wird eine neue Webanforderung mit einer neuen `DbContext`-Instanz gestellt.</span><span class="sxs-lookup"><span data-stu-id="da29d-240">When the HttpPost `Edit` action method is called,  a new web request is made and you have a new instance of the `DbContext`.</span></span> <span data-ttu-id="da29d-241">Wenn Sie die Entität erneut in diesem neuen Kontext lesen, simulieren Sie die Desktopverarbeitung.</span><span class="sxs-lookup"><span data-stu-id="da29d-241">If you re-read the entity in that new context, you simulate desktop processing.</span></span>

<span data-ttu-id="da29d-242">Wenn Sie den zusätzlichen Lesevorgang jedoch nicht ausführen wollen, müssen Sie das Entitätsobjekt verwenden, das von der Modellbindung erstellt wurde.</span><span class="sxs-lookup"><span data-stu-id="da29d-242">But if you don't want to do the extra read operation, you have to use the entity object created by the model binder.</span></span>  <span data-ttu-id="da29d-243">Die einfachste Möglichkeit hierfür ist, den Entitätsstatus auf „geändert“ festzulegen, wie in dem zuvor gezeigten alternativen HttpPost-Edit-Code.</span><span class="sxs-lookup"><span data-stu-id="da29d-243">The simplest way to do this is to set the entity state to Modified as is done in the alternative HttpPost Edit code shown earlier.</span></span> <span data-ttu-id="da29d-244">Wenn Sie dann `SaveChanges` aufrufen, aktualisiert Entity Framework alle Spalten der Datenbankzeile, da der Kontext nicht wissen kann, welche Eigenschaften Sie geändert haben.</span><span class="sxs-lookup"><span data-stu-id="da29d-244">Then when you call `SaveChanges`, the Entity Framework updates all columns of the database row, because the context has no way to know which properties you changed.</span></span>

<span data-ttu-id="da29d-245">Der Code ist komplexer, wenn Sie den Read-First-Ansatz nicht nutzen wollen, gleichzeitig aber die SQL UPDATE-Anweisung nur zum Aktualisieren der Felder verwenden wollen, die tatsächlich vom Benutzer geändert wurden.</span><span class="sxs-lookup"><span data-stu-id="da29d-245">If you want to avoid the read-first approach, but you also want the SQL UPDATE statement to update only the fields that the user actually changed, the code is more complex.</span></span> <span data-ttu-id="da29d-246">Sie müssen die ursprünglichen Werte auf irgendeine Weise speichern (z.B. mithilfe von ausgeblendeten Feldern), damit sie verfügbar sind, wenn die HttpPost-Methode `Edit` aufgerufen wird.</span><span class="sxs-lookup"><span data-stu-id="da29d-246">You have to save the original values in some way (such as by using hidden fields) so that they're available when the HttpPost `Edit` method is called.</span></span> <span data-ttu-id="da29d-247">Dann können Sie eine Entität „Student“ mit den ursprünglichen Werten erstellen, die Methode `Attach` mit der Originalversion der Entität aufrufen, die Werte dieser Entität auf neue Werte aktualisieren und dann `SaveChanges` aufrufen.</span><span class="sxs-lookup"><span data-stu-id="da29d-247">Then you can create a Student entity using the original values, call the `Attach` method with that original version of the entity, update the entity's values to the new values, and then call `SaveChanges`.</span></span>

### <a name="test-the-edit-page"></a><span data-ttu-id="da29d-248">Testen der Seite „Edit“ (Bearbeiten)</span><span class="sxs-lookup"><span data-stu-id="da29d-248">Test the Edit page</span></span>

<span data-ttu-id="da29d-249">Führen Sie die Anwendung aus, wählen Sie die Registerkarte **Students** aus, und klicken Sie dann auf den Link **Edit** (Bearbeiten).</span><span class="sxs-lookup"><span data-stu-id="da29d-249">Run the app, select the **Students** tab, then click an **Edit** hyperlink.</span></span>

![Bearbeitungsseite „Students“](crud/_static/student-edit.png)

<span data-ttu-id="da29d-251">Ändern Sie einige der Daten, und klicken Sie auf **Speichern**.</span><span class="sxs-lookup"><span data-stu-id="da29d-251">Change some of the data and click **Save**.</span></span> <span data-ttu-id="da29d-252">Die Seite **Index** wird geöffnet, und die geänderten Daten werden angezeigt.</span><span class="sxs-lookup"><span data-stu-id="da29d-252">The **Index** page opens and you see the changed data.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="da29d-253">Aktualisieren der Seite „Delete“ (Löschen)</span><span class="sxs-lookup"><span data-stu-id="da29d-253">Update the Delete page</span></span>

<span data-ttu-id="da29d-254">Der Vorlagencode für die HttpGet-Methode `Delete` in der Datei *StudentController.cs* verwendet die Methode `SingleOrDefaultAsync`, um die ausgewählte Entität „Student“ abzurufen, wie Sie bereits in den Methoden zu den Details und dem Bearbeiten gesehen haben.</span><span class="sxs-lookup"><span data-stu-id="da29d-254">In *StudentController.cs*, the template code for the HttpGet `Delete` method uses the `SingleOrDefaultAsync` method to retrieve the selected Student entity, as you saw in the Details and Edit methods.</span></span> <span data-ttu-id="da29d-255">Allerdings müssen Sie dieser Methode und der dazugehörigen Ansicht einige Funktionen hinzufügen, um eine benutzerdefinierte Fehlermeldung zu implementieren, wenn der Aufruf von `SaveChanges` fehlschlägt.</span><span class="sxs-lookup"><span data-stu-id="da29d-255">However, to implement a custom error message when the call to `SaveChanges` fails, you'll add some functionality to this method and its corresponding view.</span></span>

<span data-ttu-id="da29d-256">Wie Sie bereits bei den Vorgängen zum Aktualisieren und Erstellen gesehen haben, benötigen Löschvorgänge zwei Aktionsmethoden.</span><span class="sxs-lookup"><span data-stu-id="da29d-256">As you saw for update and create operations, delete operations require two action methods.</span></span> <span data-ttu-id="da29d-257">Die Methode, die als Antwort zu einer GET-Anforderung aufgerufen wird, stellt eine Ansicht dar, die dem Benutzer ermöglicht, den Löschvorgang zu genehmigen oder abzubrechen.</span><span class="sxs-lookup"><span data-stu-id="da29d-257">The method that's called in response to a GET request displays a view that gives the user a chance to approve or cancel the delete operation.</span></span> <span data-ttu-id="da29d-258">Wenn der Benutzer diesen Löschvorgang genehmigt, wird eine POST-Anforderung erstellt.</span><span class="sxs-lookup"><span data-stu-id="da29d-258">If the user approves it, a POST request is created.</span></span> <span data-ttu-id="da29d-259">Wenn dies geschieht, wird die HttpPost-Methode `Delete` aufgerufen, und dann führt diese Methode den Löschvorgang aus.</span><span class="sxs-lookup"><span data-stu-id="da29d-259">When that happens, the HttpPost `Delete` method is called and then that method actually performs the delete operation.</span></span>

<span data-ttu-id="da29d-260">Fügen Sie der HttpPost-Methode `Delete` einen Try-Catch-Block hinzu, um jegliche Fehler zu behandeln, die auftreten können, wenn die Datenbank aktualisiert wird.</span><span class="sxs-lookup"><span data-stu-id="da29d-260">You'll add a try-catch block to the HttpPost `Delete` method to handle any errors that might occur when the database is updated.</span></span> <span data-ttu-id="da29d-261">Wenn ein Fehler auftritt, ruft die HttpPost-Delete-Methode die HttpGet-Delete-Methode auf und übergibt ihr einen Parameter, der angibt, dass ein Fehler aufgetreten ist.</span><span class="sxs-lookup"><span data-stu-id="da29d-261">If an error occurs, the HttpPost Delete method calls the HttpGet Delete method, passing it a parameter that indicates that an error has occurred.</span></span> <span data-ttu-id="da29d-262">Die HttpGet-Delete-Methode zeigt die Bestätigungsseite mit der Fehlermeldung erneut an, damit der Benutzer eine weitere Möglichkeit erhält, den Vorgang erneut zu versuchen oder abzubrechen.</span><span class="sxs-lookup"><span data-stu-id="da29d-262">The HttpGet Delete method then redisplays the confirmation page along with the error message, giving the user an opportunity to cancel or try again.</span></span>

<span data-ttu-id="da29d-263">Ersetzen Sie die HttpGet-Aktionsmethode `Delete` mit folgendem Code für die Verwaltung der Fehlerberichtserstattung:</span><span class="sxs-lookup"><span data-stu-id="da29d-263">Replace the HttpGet `Delete` action method with the following code, which manages error reporting.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteGet&highlight=1,9,16-21)]

<span data-ttu-id="da29d-264">Dieser Code akzeptiert einen optionalen Parameter, der angibt, ob die Methode nach einem Fehler beim Speichern von Änderungen aufgerufen wurde.</span><span class="sxs-lookup"><span data-stu-id="da29d-264">This code accepts an optional parameter that indicates whether the method was called after a failure to save changes.</span></span> <span data-ttu-id="da29d-265">Dieser Parameter ist FALSE, wenn die HttpGet-Methode `Delete` aufgerufen wird, ohne dass vorher ein Fehler ausgelöst wurde.</span><span class="sxs-lookup"><span data-stu-id="da29d-265">This parameter is false when the HttpGet `Delete` method is called without a previous failure.</span></span> <span data-ttu-id="da29d-266">Wenn sie als Antwort auf einen Datenbankaktualisierungsfehler von der HttpPost-Methode `Delete` aufgerufen wird, ist der Parameter TRUE und eine Fehlermeldung wird an die Ansicht übergeben.</span><span class="sxs-lookup"><span data-stu-id="da29d-266">When it's called by the HttpPost `Delete` method in response to a database update error, the parameter is true and an error message is passed to the view.</span></span>

### <a name="the-read-first-approach-to-httppost-delete"></a><span data-ttu-id="da29d-267">Der Read-First-Ansatz zu HttpPost-Delete</span><span class="sxs-lookup"><span data-stu-id="da29d-267">The read-first approach to HttpPost Delete</span></span>

<span data-ttu-id="da29d-268">Ersetzen Sie die HttpPost-Aktionsmethode `Delete` (namens `DeleteConfirmed`) mit folgendem Code, der den tatsächlichen Löschvorgang ausführt und jegliche Datenbankaktualisierungsfehler abfängt:</span><span class="sxs-lookup"><span data-stu-id="da29d-268">Replace the HttpPost `Delete` action method (named `DeleteConfirmed`) with the following code, which performs the actual delete operation and catches any database update errors.</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithReadFirst&highlight=6,8-11,13-14,18-23)]

<span data-ttu-id="da29d-269">Dieser Code ruft die ausgewählte Entität ab und anschließend die Methode `Remove` auf, um den Status der Entität auf `Deleted` festzulegen.</span><span class="sxs-lookup"><span data-stu-id="da29d-269">This code retrieves the selected entity, then calls the `Remove` method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="da29d-270">Wenn `SaveChanges` aufgerufen wird, wird der SQL-Befehl DELETE generiert.</span><span class="sxs-lookup"><span data-stu-id="da29d-270">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span>

### <a name="the-create-and-attach-approach-to-httppost-delete"></a><span data-ttu-id="da29d-271">Der Create-and-Attach-Ansatz zu HttpPost-Delete</span><span class="sxs-lookup"><span data-stu-id="da29d-271">The create-and-attach approach to HttpPost Delete</span></span>

<span data-ttu-id="da29d-272">Wenn das Verbessern der Leistung in einer Anwendung mit hohem Volumen eine Priorität ist, können Sie eine überflüssige SQL-Abfrage durch das Instanziieren einer Entität „Student“ vermeiden, indem Sie nur einen primären Schlüsselwert verwenden und den Entitätsstatus auf `Deleted` festlegen.</span><span class="sxs-lookup"><span data-stu-id="da29d-272">If improving performance in a high-volume application is a priority, you could avoid an unnecessary SQL query by instantiating a Student entity using only the primary key value and then setting the entity state to `Deleted`.</span></span> <span data-ttu-id="da29d-273">Das ist alles, was Entity Framework benötigt, um die Entität löschen zu können.</span><span class="sxs-lookup"><span data-stu-id="da29d-273">That's all that the Entity Framework needs in order to delete the entity.</span></span> <span data-ttu-id="da29d-274">(Fügen Sie diesen Code nicht in Ihr Projekt ein, er wird hier nur gezeigt, um eine alternative Vorgehensweise zu veranschaulichen.)</span><span class="sxs-lookup"><span data-stu-id="da29d-274">(Don't put this code in your project; it's here just to illustrate an alternative.)</span></span>

[!code-csharp[](intro/samples/cu/Controllers/StudentsController.cs?name=snippet_DeleteWithoutReadFirst&highlight=7-8)]

<span data-ttu-id="da29d-275">Wenn die Entität zugehörige Daten besitzt, die auch gelöscht werden sollen, sollten Sie sicherstellen, dass das kaskadierende Delete in der Datenbank konfiguriert ist.</span><span class="sxs-lookup"><span data-stu-id="da29d-275">If the entity has related data that should also be deleted, make sure that cascade delete is configured in the database.</span></span> <span data-ttu-id="da29d-276">Bei diesem Ansatz erkennt Entity Framework möglicherweise nicht, dass zugehörige Entitäten vorhanden sind, die gelöscht werden sollen.</span><span class="sxs-lookup"><span data-stu-id="da29d-276">With this approach to entity deletion, EF might not realize there are related entities to be deleted.</span></span>

### <a name="update-the-delete-view"></a><span data-ttu-id="da29d-277">Aktualisieren der Ansicht „Löschen“</span><span class="sxs-lookup"><span data-stu-id="da29d-277">Update the Delete view</span></span>

<span data-ttu-id="da29d-278">Fügen Sie in der Datei *Views/Student/Delete.cshtml* eine Fehlermeldung zwischen der Überschrift „h2“ und der Überschrift „h3“ eine Fehlermeldung ein, wie im folgenden Beispiel gezeigt wird:</span><span class="sxs-lookup"><span data-stu-id="da29d-278">In *Views/Student/Delete.cshtml*, add an error message between the h2 heading and the h3 heading, as shown in the following example:</span></span>

[!code-html[](intro/samples/cu/Views/Students/Delete.cshtml?range=7-9&highlight=2)]

<span data-ttu-id="da29d-279">Führen Sie die Anwendung aus, wählen Sie die Registerkarte **Students** aus und klicken auf den Link **Löschen**:</span><span class="sxs-lookup"><span data-stu-id="da29d-279">Run the app, select the **Students** tab, and click a **Delete** hyperlink:</span></span>

![Bestätigungsseite „Löschen“](crud/_static/student-delete.png)

<span data-ttu-id="da29d-281">Klicken Sie auf **Löschen**.</span><span class="sxs-lookup"><span data-stu-id="da29d-281">Click **Delete**.</span></span> <span data-ttu-id="da29d-282">Die Indexseite wird ohne den gelöschten Student angezeigt.</span><span class="sxs-lookup"><span data-stu-id="da29d-282">The Index page is displayed without the deleted student.</span></span> <span data-ttu-id="da29d-283">(Ein Beispiel für den Fehlerbehandlungscode in Aktion im Tutorial zur Parallelität wird angezeigt.)</span><span class="sxs-lookup"><span data-stu-id="da29d-283">(You'll see an example of the error handling code in action in the concurrency tutorial.)</span></span>

## <a name="closing-database-connections"></a><span data-ttu-id="da29d-284">Trennen von Datenbankverbindungen</span><span class="sxs-lookup"><span data-stu-id="da29d-284">Closing database connections</span></span>

<span data-ttu-id="da29d-285">Sobald Sie mit ihr fertig sind, muss die Kontextinstanz so bald wie möglich entfernt werden, um die Ressourcen der Datenbankverbindung freizugeben.</span><span class="sxs-lookup"><span data-stu-id="da29d-285">To free up the resources that a database connection holds, the context instance must be disposed as soon as possible when you are done with it.</span></span> <span data-ttu-id="da29d-286">Die in ASP.NET Core eingebaute [Dependency Injection](../../fundamentals/dependency-injection.md) erledigt diese Aufgabe für Sie.</span><span class="sxs-lookup"><span data-stu-id="da29d-286">The ASP.NET Core built-in [dependency injection](../../fundamentals/dependency-injection.md) takes care of that task for you.</span></span>

<span data-ttu-id="da29d-287">Rufen Sie die [Erweiterungsmethode AddDbContext](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) in der Datei *Startup.cs* auf, um die Klasse `DbContext` in dem ASP.NET DI-Container bereitzustellen.</span><span class="sxs-lookup"><span data-stu-id="da29d-287">In *Startup.cs*, you call the [AddDbContext extension method](https://github.com/aspnet/EntityFrameworkCore/blob/03bcb5122e3f577a84498545fcf130ba79a3d987/src/Microsoft.EntityFrameworkCore/EntityFrameworkServiceCollectionExtensions.cs) to provision the `DbContext` class in the ASP.NET DI container.</span></span> <span data-ttu-id="da29d-288">Diese Methode legt die Lebensdauer des Diensts standardgemäß auf `Scoped` fest.</span><span class="sxs-lookup"><span data-stu-id="da29d-288">That method sets the service lifetime to `Scoped` by default.</span></span> <span data-ttu-id="da29d-289">`Scoped` bedeutet, dass die Lebensdauer des Kontextobjekts mit der Lebensdauer der Webanforderung übereinstimmt, und die Methode `Dispose` wird am Ende der Webanforderung automatisch aufgerufen.</span><span class="sxs-lookup"><span data-stu-id="da29d-289">`Scoped` means the context object lifetime coincides with the web request life time, and the `Dispose` method will be called automatically at the end of the web request.</span></span>

## <a name="handling-transactions"></a><span data-ttu-id="da29d-290">Verarbeiten von Transaktionen</span><span class="sxs-lookup"><span data-stu-id="da29d-290">Handling Transactions</span></span>

<span data-ttu-id="da29d-291">Standardgemäß implementiert Entity Framework implizit Transaktionen.</span><span class="sxs-lookup"><span data-stu-id="da29d-291">By default the Entity Framework implicitly implements transactions.</span></span> <span data-ttu-id="da29d-292">In Szenarios, in denen Sie Änderungen an mehreren Zeilen oder Tabellen vornehmen und dann `SaveChanges` aufrufen, stellt Entity Framework automatisch sicher, dass alle Ihre Änderungen entweder fehlschlagen oder erfolgreich abgeschlossen werden.</span><span class="sxs-lookup"><span data-stu-id="da29d-292">In scenarios where you make changes to multiple rows or tables and then call `SaveChanges`, the Entity Framework automatically makes sure that either all of your changes succeed or they all fail.</span></span> <span data-ttu-id="da29d-293">Wenn ein Fehler auftritt, nachdem einige der Änderungen durchgeführt wurden, werden diese Änderungen automatisch zurückgesetzt.</span><span class="sxs-lookup"><span data-stu-id="da29d-293">If some changes are done first and then an error happens, those changes are automatically rolled back.</span></span> <span data-ttu-id="da29d-294">Informationen zu Szenarios, die Sie genauer kontrollieren müssen (z.B. wenn Sie Vorgänge einfügen möchten, die außerhalb von Entity Framework in einer Transaktion ausgeführt werden), finden Sie unter [Transaktionen](https://docs.microsoft.com/ef/core/saving/transactions).</span><span class="sxs-lookup"><span data-stu-id="da29d-294">For scenarios where you need more control -- for example, if you want to include operations done outside of Entity Framework in a transaction -- see [Transactions](https://docs.microsoft.com/ef/core/saving/transactions).</span></span>

## <a name="no-tracking-queries"></a><span data-ttu-id="da29d-295">Abfragen ohne Nachverfolgung</span><span class="sxs-lookup"><span data-stu-id="da29d-295">No-tracking queries</span></span>

<span data-ttu-id="da29d-296">Wenn ein Datenbankkontext Tabellenzeilen abruft und Entitätsobjekte erstellt, die diese darstellen, verfolgen sie standardgemäß, ob die Entitäten im Arbeitsspeicher mit dem Inhalt der Datenbank synchronisiert sind.</span><span class="sxs-lookup"><span data-stu-id="da29d-296">When a database context retrieves table rows and creates entity objects that represent them, by default it keeps track of whether the entities in memory are in sync with what's in the database.</span></span> <span data-ttu-id="da29d-297">Die Daten im Arbeitsspeicher fungieren als Cache und werden verwendet, wenn Sie eine Entität aktualisieren.</span><span class="sxs-lookup"><span data-stu-id="da29d-297">The data in memory acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="da29d-298">Diese Zwischenspeicherung ist in Webanwendungen oft überflüssig, da Kontextinstanzen in der Regel kurzlebig sind (eine neue wird bei jeder Anforderung erstellt und gelöscht), und der Kontext, der eine Entität liest, wird in der Regel gelöscht, bevor diese Entität erneut verwendet wird.</span><span class="sxs-lookup"><span data-stu-id="da29d-298">This caching is often unnecessary in a web application because context instances are typically short-lived (a new one is created and disposed for each request) and the context that reads an entity is typically disposed before that entity is used again.</span></span>

<span data-ttu-id="da29d-299">Sie können die Nachverfolgung von Entitätsobjekten im Arbeitsspeicher deaktivieren, indem Sie die Methode `AsNoTracking` aufrufen.</span><span class="sxs-lookup"><span data-stu-id="da29d-299">You can disable tracking of entity objects in memory by calling the `AsNoTracking` method.</span></span> <span data-ttu-id="da29d-300">Typische Szenarios, in denen Sie das möglicherweise tun wollen, umfassen Folgendes:</span><span class="sxs-lookup"><span data-stu-id="da29d-300">Typical scenarios in which you might want to do that include the following:</span></span>

* <span data-ttu-id="da29d-301">Während der Lebensdauer des Kontexts müssen Sie keine Entitäten aktualisieren, und EF muss [Navigationseigenschaften mit Entitäten, die durch separate Abfragen abgerufen wurden, nicht automatisch laden](read-related-data.md).</span><span class="sxs-lookup"><span data-stu-id="da29d-301">During the context lifetime you don't need to update any entities, and you don't need EF to [automatically load navigation properties with  entities retrieved by separate queries](read-related-data.md).</span></span> <span data-ttu-id="da29d-302">Diese Bedingungen werden häufig in den HttpGet-Aktionsmethoden eines Controllers erfüllt.</span><span class="sxs-lookup"><span data-stu-id="da29d-302">Frequently these conditions are met in a controller's HttpGet action methods.</span></span>

* <span data-ttu-id="da29d-303">Sie führen eine Abfrage aus, die große Datenmengen abruft, und nur ein kleiner Teil dieser Daten wird aktualisiert.</span><span class="sxs-lookup"><span data-stu-id="da29d-303">You are running a query that retrieves a large volume of data, and only a small portion of the returned data will be updated.</span></span> <span data-ttu-id="da29d-304">Bei großen Abfragen kann es effizienter sein, die Nachverfolgung zu deaktivieren, und zu einem späteren Zeitpunkt eine Abfrage für die wenigen Entitäten auszuführen, die aktualisiert werden müssen.</span><span class="sxs-lookup"><span data-stu-id="da29d-304">It may be more efficient to turn off tracking for the large query, and run a query later for the few entities that need to be updated.</span></span>

* <span data-ttu-id="da29d-305">Sie sollten eine Entität anfügen, um diese zu aktualisieren, jedoch haben Sie eben diese Entität bereits für einen anderen Zweck abgerufen.</span><span class="sxs-lookup"><span data-stu-id="da29d-305">You want to attach an entity in order to update it, but earlier you retrieved the same entity for a different purpose.</span></span> <span data-ttu-id="da29d-306">Da diese Entität bereits vom Datenbankkontext nachverfolgt wird, können Sie die zu ändernde Entität nicht anfügen.</span><span class="sxs-lookup"><span data-stu-id="da29d-306">Because the entity is already being tracked by the database context, you can't attach the entity that you want to change.</span></span> <span data-ttu-id="da29d-307">Ein Weg, diese Situation zu bewältigen, ist `AsNoTracking` auf der vorherigen Abfrage aufzurufen.</span><span class="sxs-lookup"><span data-stu-id="da29d-307">One way to handle this situation is to call `AsNoTracking` on the earlier query.</span></span>

<span data-ttu-id="da29d-308">Weitere Informationen finden Sie unter [Tracking vs. No-Tracking (Mit Nachverfolgung gegen ohne Nachverfolgung)](https://docs.microsoft.com/ef/core/querying/tracking).</span><span class="sxs-lookup"><span data-stu-id="da29d-308">For more information, see [Tracking vs. No-Tracking](https://docs.microsoft.com/ef/core/querying/tracking).</span></span>

## <a name="summary"></a><span data-ttu-id="da29d-309">Zusammenfassung</span><span class="sxs-lookup"><span data-stu-id="da29d-309">Summary</span></span>

<span data-ttu-id="da29d-310">Sie verfügen jetzt über einen vollständigen Satz von Seiten, die dazu in der Lage sind, einfache CRUD-Vorgänge für Student-Entitäten auszuführen.</span><span class="sxs-lookup"><span data-stu-id="da29d-310">You now have a complete set of pages that perform simple CRUD operations for Student entities.</span></span> <span data-ttu-id="da29d-311">Im nächsten Tutorial erweitern Sie die Funktionen der Seite **Index**, indem Sie das Sortieren, Filtern und Paging hinzufügen.</span><span class="sxs-lookup"><span data-stu-id="da29d-311">In the next tutorial you'll expand the functionality of the **Index** page by adding sorting, filtering, and paging.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="da29d-312">[Zurück](intro.md)
> [Weiter](sort-filter-page.md)</span><span class="sxs-lookup"><span data-stu-id="da29d-312">[Previous](intro.md)
[Next](sort-filter-page.md)</span></span>  
